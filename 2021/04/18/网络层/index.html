<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>计算机网络-网络层 | Dong</title><meta name="author" content="天际线上的猪"><meta name="copyright" content="天际线上的猪"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="内容最多、计算题最多也最重要的一章——网络层">
<meta property="og:type" content="article">
<meta property="og:title" content="计算机网络-网络层">
<meta property="og:url" content="http://dong-666.github.io/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/index.html">
<meta property="og:site_name" content="Dong">
<meta property="og:description" content="内容最多、计算题最多也最重要的一章——网络层">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://dong-666.github.io/img/code.jpg">
<meta property="article:published_time" content="2021-04-18T07:28:20.000Z">
<meta property="article:modified_time" content="2022-04-17T13:31:58.933Z">
<meta property="article:author" content="天际线上的猪">
<meta property="article:tag" content="计算机网络">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://dong-666.github.io/img/code.jpg"><link rel="shortcut icon" href="/img/favicon3.png"><link rel="canonical" href="http://dong-666.github.io/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":false,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: 天际线上的猪","link":"链接: ","source":"来源: Dong","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '计算机网络-网络层',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-04-17 21:31:58'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="Dong" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">106</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">35</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">14</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/te/"><i class="fa-fw fas fa-map"></i><span> 疫情地图</span></a></div><div class="menus_item"><a class="site-page" href="/todolist/"><i class="fa-fw fas fa-check-circle"></i><span> ToDoList</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-camera"></i><span> Gallery</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/code.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Dong"><span class="site-name">Dong</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/te/"><i class="fa-fw fas fa-map"></i><span> 疫情地图</span></a></div><div class="menus_item"><a class="site-page" href="/todolist/"><i class="fa-fw fas fa-check-circle"></i><span> ToDoList</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-camera"></i><span> Gallery</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">计算机网络-网络层</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-04-18T07:28:20.000Z" title="发表于 2021-04-18 15:28:20">2021-04-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-04-17T13:31:58.933Z" title="更新于 2022-04-17 21:31:58">2022-04-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">25.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>80分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="计算机网络-网络层"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/" itemprop="commentCount"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>注：内容根据《计算机网络第七版》以及相关PPT整理制作，图片主要源于{电子工程出版社}，部分图片源于学校老师上课所画的图以及自己制作的思维导图</p>
</blockquote>
<h1 id="网络层提供何种服务"><a href="#网络层提供何种服务" class="headerlink" title="网络层提供何种服务"></a>网络层提供何种服务</h1><p>首先，从以下问题进入网络层的学习（书里就是这样）</p>
<p>在计算机网络领域，网络层应该向运输层提供怎样的服务<strong>（“面向连接”还是“无连接”</strong>）曾引起了长期的争论。<br>争论焦点的实质就是：在计算机通信中，<strong>可靠交付</strong>应当由谁来负责？是<strong>网络</strong>还是<strong>端系统</strong>？ </p>
<h2 id="让网络负责可靠交付"><a href="#让网络负责可靠交付" class="headerlink" title="让网络负责可靠交付"></a>让网络负责可靠交付</h2><p>这种观点认为，应借助于电信网的成功经验，让网络负责可靠交付，计算机网络应模仿电信网络，使用<strong>面向连接</strong>的通信方式。通信之前先建立<strong>虚电路 (Virtual Circuit)</strong>，以保证双方通信所需的一切网络资源。 如果再使用<strong>可靠传输</strong>的网络协议，就可使所发送的分组<strong>无差错按序</strong>到达终点，不丢失、不重复。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415181401821.png" alt="H1 发送给 H2 的所有分组都沿着同一条虚电路传送"></p>
<p>H1 发送给 H2 的所有分组都沿着同一条虚电路传送</p>
<p>虚电路表示这只是一条<strong>逻辑上的连接</strong>，分组都沿着这条逻辑连接按照<strong>存储转发方式</strong>传送，而并不是真正建立了一条物理连接。<strong>请注意，电路交换的电话通信是先建立了一条真正的连接。</strong>因此分组交换的虚连接和电路交换的连接只是类似，但并不完全一样。 </p>
<blockquote>
<p>这样的情况已经遇到很多次了且很重要，在上一章数据链路层也讲了这种逻辑链接，为了屏蔽掉复杂的数据传递过程，我们会频繁的使用逻辑连接这一方法来帮助我们理解对等层之间的通信问题，放心，在接下来的运输层（TCP、UDP）和应用层（HTTP）也同样会使用该方法</p>
</blockquote>
<h2 id="网络提供数据报服务"><a href="#网络提供数据报服务" class="headerlink" title="网络提供数据报服务"></a>网络提供数据报服务</h2><p>互联网的先驱者提出了一种崭新的网络设计思路。网络层向上只提供简单灵活的、<strong>无连接的、尽最大努力交付的数据报服务</strong>。</p>
<p>网络在发送分组时不需要先建立连接。每一个分组（即 IP 数据报）独立发送，<strong>与其前后的分组无关</strong>（不进行编号）。</p>
<p>网络层<strong>不提供服务质量的承诺</strong>。即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），当然也不保证分组传送的时限。 </p>
<p>由于传输网络<strong>不提供端到端的可靠传输服务</strong>，这就使网络中的路由器可以做得比较简单，而且价格低廉（与电信网的交换机相比较）。如果主机（即端系统）中的进程之间的通信需要是可靠的，那么就由网络的主机中的<strong>运输层负责可靠交付</strong>（包括差错处理、流量控制等） 。</p>
<p>采用这种设计思路的好处是：<strong>网络的造价大大降低，运行方式灵活</strong>，能够适应多种应用。</p>
<p>这也证明了互连网能够发展到今日的规模，缘于当初采用这种设计思路的正确性。 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415182142417.png" alt="image-20210415182142417"></p>
<p>最后的答案就是<strong>端系统负责可靠交付</strong>啦，然后网络负责提供<strong>无连接的、尽最大努力交付的数据报服务</strong></p>
<p>丢出一张表对比下虚电路服务和数据报服务</p>
<table>
<thead>
<tr>
<th align="left">对比的方面</th>
<th align="left">虚电路服务</th>
<th align="left">数据报服务</th>
</tr>
</thead>
<tbody><tr>
<td align="left">思路</td>
<td align="left">可靠通信应当由网络来保证</td>
<td align="left">可靠通信应当由用户主机来保证</td>
</tr>
<tr>
<td align="left">连接的建立</td>
<td align="left">必须有</td>
<td align="left">不需要</td>
</tr>
<tr>
<td align="left">终点地址</td>
<td align="left">仅在连接建立阶段使用，每个分组使用短的虚电路号</td>
<td align="left">每个分组都有终点的完整地址</td>
</tr>
<tr>
<td align="left">分组的转发</td>
<td align="left">属于同一条虚电路的分组均按照同一路由进行转发</td>
<td align="left">每个分组独立选择路由进行转发</td>
</tr>
<tr>
<td align="left">当结点出故障时</td>
<td align="left">所有通过出故障的结点的虚电路均不能工作</td>
<td align="left">出故障的结点可能会丢失分组，一些路由可能会发生变化</td>
</tr>
<tr>
<td align="left">分组的顺序</td>
<td align="left">总是按发送顺序到达终点</td>
<td align="left">到达终点时不一定按发送顺序</td>
</tr>
<tr>
<td align="left">端到端的差错处理和流量控制</td>
<td align="left">可以由网络负责，也可以由用户主机负责</td>
<td align="left">由用户主机负责</td>
</tr>
</tbody></table>
<h1 id="网际协议-IP"><a href="#网际协议-IP" class="headerlink" title="网际协议 IP"></a>网际协议 IP</h1><p>网际协议 IP 是 TCP/IP 体系中两个最主要的协议之一。</p>
<p>与 IP 协议配套使用的还有三个协议：</p>
<ol>
<li><strong>地址解析协议 ARP (Address Resolution Protocol)</strong></li>
<li><strong>网际控制报文协议 ICMP (Internet Control Message Protocol)</strong></li>
<li><strong>网际组管理协议 IGMP (Internet Group Management Protocol)</strong></li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415183411541.png" alt="image-20210415183411541"></p>
<h2 id="虚拟互连网络"><a href="#虚拟互连网络" class="headerlink" title="虚拟互连网络"></a>虚拟互连网络</h2><p>将网络互连并能够互相通信，会遇到许多问题需要解决，如：</p>
<ol>
<li>不同的寻址方案</li>
<li>不同的最大分组长度</li>
<li>不同的网络接入机制</li>
<li>不同的超时控制</li>
<li>不同的差错恢复方法</li>
<li>不同的状态报告方法</li>
<li>不同的路由选择技术</li>
<li>不同的用户接入控制</li>
<li>不同的服务（面向连接服务和无连接服务）</li>
<li>不同的管理与控制方式等</li>
</ol>
<p>妈耶这也太多了，所以这一章的内容是最多的，同时理论上也是五层协议里面最复杂最重要的一章，也会包含了一些计算题</p>
<p>将网络互相连接起来要使用一些中间设备。 中间设备又称为<strong>中间系统或中继 (relay)系统</strong>。有以下五种不同的中间设备：</p>
<ol>
<li>物理层中继系统：<strong>转发器 (repeater)</strong>。</li>
<li>数据链路层中继系统：<strong>网桥</strong> 或 <strong>桥接器 (bridge)</strong>。</li>
<li>网络层中继系统：<strong>路由器 (router)</strong>。</li>
<li>网桥和路由器的混合物：<strong>桥路器 (brouter)</strong>。</li>
<li>网络层以上的中继系统：<strong>网关 (gateway)</strong>。 </li>
</ol>
<p>当中继系统是转发器或网桥时，一般并不称之为网络互连，因为这仅仅是把一个网络扩大了，而这仍然是一个网络。（回想下数据链路层的集线器以及交换机的工作） 网关由于比较复杂，目前使用得较少。<br><strong>网络互连都是指用路由器进行网络互连和路由选择。</strong>由于历史的原因，许多有关 TCP/IP 的文献将网络层使用的路由器称为网关。   </p>
<h3 id="虚拟互连网络的意义"><a href="#虚拟互连网络的意义" class="headerlink" title="虚拟互连网络的意义"></a>虚拟互连网络的意义</h3><p><strong>所谓虚拟互连网络也就是逻辑互连网络</strong>，它的意思就是互连起来的各种物理网络的异构性本来是客观存在的，但是我们利用 IP 协议就可以使这些性能各异的网络从用户看起来好像是一个统一的网络。使用 IP 协议的虚拟互连网络可简称为 IP 网。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415192112095.png" alt="image-20210415192112095"></p>
<p><strong>使用虚拟互连网络的好处是</strong>：当互联网上的主机进行通信时，就好像在一个网络上通信一样，而看不见互连的各具体的网络异构细节。如果在这种覆盖全球的 IP 网的上层使用 <strong>TCP 协议</strong>（运输层），那么就是现在的互联网 (Internet)。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415192705638.png" alt="image-20210415192705638"></p>
<p>最后，从网络层去考虑问题（联想下数据链路层考虑问题的方法），那么 IP 数据报就可以想象是在网络层中传送。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415194411960.png" alt="image-20210415194411960"></p>
<h2 id="分类的-IP-地址"><a href="#分类的-IP-地址" class="headerlink" title="分类的 IP 地址"></a>分类的 IP 地址</h2><h3 id="IP-地址及其表示方法"><a href="#IP-地址及其表示方法" class="headerlink" title="IP 地址及其表示方法"></a>IP 地址及其表示方法</h3><p>我们把整个互联网看成为一个单一的、抽象的网络。IP 地址就是给每个连接在互联网上的主机（或路由器）分配一个在全世界范围是<strong>唯一的 32 位的标识符</strong>。</p>
<p>IP 地址现在由互联网名字和数字分配机构ICANN (Internet Corporation for Assigned Names and Numbers)进行分配。 </p>
<p><strong>IP 地址的编址方法</strong></p>
<p><strong>分类的 IP 地址。</strong>这是最<strong>基本的编址方法</strong>，在1981年就通过了相应的标准协议。</p>
<p><strong><a href="#划分子网和构造超网">子网的划分</a>。</strong>这是对最基本的编址方法的改进，其标准[RFC 950]在1985年通过。</p>
<p><strong><a href="#划分子网和构造超网">构成超网</a>。</strong>这是比较新的<strong>无分类编址方法</strong>。1993年提出后很快就得到推广应用。</p>
<p>先来讲讲第一个IP地址的分类，后面两个会在第三节提到</p>
<p>将IP地址划分为若干个固定类。</p>
<p>每一类地址都由两个固定长度的字段组成，其中一个字段是<strong>网络号 net-id</strong>，它标志主机（或路由器）所连接到的网络，而另一个字段则是<strong>主机号 host-id</strong>，它标志该主机（或路由器）。</p>
<p>主机号在它前面的网络号所指明的网络范围内必须是唯一的。<br>由此可见，<strong>一个 IP 地址在整个互联网范围内是唯一的</strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415195656915.png" alt="image-20210415195656915"></p>
<p>也可以这样（::=  代表“定义为”)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415195727663.png" alt="image-20210415195727663"></p>
<p>一开始，网络被分为五类地址，后来因为<strong>无分类IP地址</strong>的广泛使用，这种区分变成了历史</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415195926200.png" alt="image-20210415195926200"></p>
<h4 id="点分十进制记法"><a href="#点分十进制记法" class="headerlink" title="点分十进制记法"></a>点分十进制记法</h4><p>机器中存放的 IP 地址是 32 位二进制代码，长这样，好记不，不好记</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415200148882.png" alt="image-20210415200148882"></p>
<p>所以，聪明的人们就想到了点分十进制法来方便我们记住ip地址</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415200242102.png" alt="image-20210415200242102"></p>
<p>下面是一堆点分十进制的具体例子</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415200310917.png" alt="image-20210415200310917"></p>
<h3 id="常用的三种类别的-IP-地址"><a href="#常用的三种类别的-IP-地址" class="headerlink" title="常用的三种类别的 IP 地址"></a>常用的三种类别的 IP 地址</h3><table>
<thead>
<tr>
<th align="left">网络  类别</th>
<th align="left">最大可指派的网络数</th>
<th>第一个可指派的网络号</th>
<th>最后一个可指派的网络号</th>
<th align="left">每个网络中最大主机数</th>
</tr>
</thead>
<tbody><tr>
<td align="left">A</td>
<td align="left">126 (27  – 2)</td>
<td>1</td>
<td>126</td>
<td align="left">16777214</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">16383 (214  – 1)</td>
<td>128.1</td>
<td>191.255</td>
<td align="left">65534</td>
</tr>
<tr>
<td align="left">C</td>
<td align="left">2097151 (221 – 1)</td>
<td>192.0.1</td>
<td>223.255.255</td>
<td align="left">254</td>
</tr>
</tbody></table>
<p>一些一般情况下不使用的特殊IP地址</p>
<table>
<thead>
<tr>
<th>网络号</th>
<th>主机号</th>
<th>源地址使用</th>
<th>目的地址使用</th>
<th>代表的意思</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>0</td>
<td>可以</td>
<td>不可</td>
<td>在本网络上的本主机（见 6.6  节 DHCP  协议）</td>
</tr>
<tr>
<td>0</td>
<td>host-id</td>
<td>可以</td>
<td>不可</td>
<td>在本网络上的某台主机 host-id</td>
</tr>
<tr>
<td>全 1</td>
<td>全 1</td>
<td>不可</td>
<td>可以</td>
<td>只在本网络上进行广播（各路由器均不转发）</td>
</tr>
<tr>
<td>net-id</td>
<td>全 1</td>
<td>不可</td>
<td>可以</td>
<td>对 net-id  上的所有主机进行广播</td>
</tr>
<tr>
<td>127</td>
<td>非全 0 或全 1 的任何数</td>
<td>可以</td>
<td>可以</td>
<td>用于本地软件环回测试</td>
</tr>
</tbody></table>
<p>注意：A类地址→127.0.0.1一般作为本主机进程之间的通信所用</p>
<h3 id="IP-地址的一些重要特点"><a href="#IP-地址的一些重要特点" class="headerlink" title="IP 地址的一些重要特点"></a>IP 地址的一些重要特点</h3><p>(1) <strong>IP 地址是一种分等级的地址结构</strong>。分两个等级的好处是：</p>
<ol>
<li>第一，IP 地址管理机构在分配 IP 地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配。这样就方便了 IP 地址的管理。</li>
<li>第二，路由器<strong>仅根据目的主机所连接的网络号来转发分组</strong>（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间。 </li>
</ol>
<p>(2) 实际上 IP 地址是标志一个主机（或路由器）和一条链路的接口。</p>
<ul>
<li>当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号 net-id 必须是不同的。这种主机称为<strong>多归属主机 (multihomed host)</strong>。</li>
<li>由于一个路由器至少应当连接到两个网络（这样它才能将 IP 数据报从一个网络转发到另一个网络），因此<strong>一个路由器至少应当有两个不同的 IP 地址</strong>。 </li>
</ul>
<p>(3) <strong>用转发器或网桥连接起来的若干个局域网仍为一个网络，因此这些局域网都具有同样的网络号 net-id</strong>。</p>
<p>(4) 所有分配到网络号 net-id 的网络，无论是范围很小的局域网，还是可能覆盖很大地理范围的广域网，都是<strong>平等的</strong>。</p>
<p>通过下面的图加深对以上特点的理解</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415201912374.png" alt="image-20210415201912374"></p>
<p>在同一个局域网上的主机或路由器的IP 地址中的网络号必须是一样的。图中的网络号就是 IP 地址中的 net-id。（各个粉色区域即各自的局域网）</p>
<p>路由器总是具有两个或两个以上的IP地址。路由器的每一个接口都有一个不同网络号的IP地址。（R1、R2、R3）</p>
<p>两个路由器直接相连的接口处，可指明也可不指明IP地址。如指明IP地址，则这一段连线就构成了一种只包含一段线路的特殊“网络” 。现在常不指明IP地址。（中间粉紫色的N1、N2、N3）</p>
<h2 id="IP-地址与硬件地址"><a href="#IP-地址与硬件地址" class="headerlink" title="IP 地址与硬件地址"></a>IP 地址与硬件地址</h2><p>IP 地址与硬件地址是不同的地址。从层次的角度看，<strong>硬件地址（或物理地址）是数据链路层和物理层使用的地址。IP 地址是网络层和以上各层使用的地址，是一种逻辑地址</strong>（称 IP 地址是逻辑地址是因为 IP 地址是用软件实现的）。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415202457509.png" alt="image-20210415202457509"></p>
<p>IP 地址放在 IP 数据报的首部，而硬件地址则放在 MAC 帧的首部。</p>
<p>我们先来看看在网络层上看，数据的具体流动方式</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415202558809.png" alt="image-20210415202558809"></p>
<p>再来看看在实际的协议栈上，数据的流动</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415202646057.png" alt="image-20210415202646057"></p>
<p>从虚拟的 IP 层上看 IP 数据报的流动（和上面的网络层的图性质类似，只不过简化了点）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415202714172.png" alt="image-20210415202714172"></p>
<p>而从链路上看呢，在具体的物理网络的链路层，只能看见 MAC 帧而看不见 IP 数据报 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415202851371.png" alt="image-20210415202851371"></p>
<p>现在回头再来看看IP协议层的数据流动，图中的  IP1 → IP2  表示从源地址 IP1 到目的地址 IP2 。两个路由器的 IP 地址并不出现在 IP 数据报的首部中。 路由器只根据目的站的 IP 地址的网络号进行路由选择。 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415202714172.png" alt="image-20210415202714172"></p>
<p>IP 层抽象的互联网屏蔽了下层很复杂的细节。在抽象的网络层上讨论问题，就能够使用统一的、抽象的 IP 地址研究主机和主机或主机和路由器之间的通信 。（会不会又啰嗦了）</p>
<p>主机 H1 与 H2 通信中使用的IP地址与硬件地址举例(根据上图理解)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415203207464.png" alt="image-20210415203207464"></p>
<h2 id="地址解析协议-ARP"><a href="#地址解析协议-ARP" class="headerlink" title="地址解析协议 ARP"></a><strong>地址解析协议 ARP</strong></h2><p>通过上面的了解，我们知道了硬件地址和IP地址的区别，现在就来考虑在实际协议栈中硬件地址和IP地址是如何进行转换的</p>
<blockquote>
<p>通信时使用了两个地址：</p>
<ol>
<li>IP 地址（网络层地址）</li>
<li>MAC 地址（数据链路层地址）</li>
</ol>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415203642454.png" alt="image-20210415203642454"></p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>地址解析协议 ARP 就是用来通过IP地址来查找对应的硬件地址</p>
<blockquote>
<p>ARP 作用：<br>从网络层使用的 IP 地址，解析出在数据链路层使用的硬件地址。</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415203805823.png" alt="image-20210415203805823"></p>
<p>通过前面我们也知道，不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址。 </p>
<p>每一个主机都设有一个 ARP 高速缓存 (ARP cache)，里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415203906033.png" alt="image-20210415203906033"></p>
<p>注：TTL (Time To Live)：地址映射有效时间 </p>
<h3 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h3><p>当主机 A 欲向本局域网上的某个主机 B 发送 IP 数据报时，就先在其 ARP 高速缓存中查看有无主机 B 的 IP 地址。如有，就可查出其对应的硬件地址，再将此硬件地址写入 MAC 帧，然后通过局域网将该 MAC 帧发往此硬件地址。如没有， ARP 进程在本局域网上广播发送一个 ARP 请求分组。收到 ARP 响应分组后，将得到的 IP 地址到硬件地址的映射写入 ARP 高速缓存。（和那啥是不是有点类似，数据链路层中交换机的工作方式）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415204254478.png" alt="image-20210415204254478"></p>
<p>解剖整段话中的要点</p>
<blockquote>
<p><strong>ARP请求分组：</strong>包含发送方硬件地址 / 发送方 IP 地址 / 目标方硬件地址(未知时填 0) / 目标方 IP 地址。</p>
<p><strong>本地广播 ARP 请求</strong>（路由器不转发ARP请求）。</p>
<p><strong>ARP 响应分组</strong>：包含发送方硬件地址 / 发送方 IP地址 / 目标方硬件地址 / 目标方 IP 地址。</p>
<p><strong>ARP 分组封装在物理网络的帧中传输。</strong></p>
</blockquote>
<h3 id="ARP-高速缓存"><a href="#ARP-高速缓存" class="headerlink" title="ARP 高速缓存"></a>ARP 高速缓存</h3><p>ARP 具有高速缓存，用来存放最近获得的 IP 地址到 MAC 地址的绑定，以减少 ARP 广播的数量。</p>
<p>为了减少网络上的通信量，主机 A 在发送其 ARP 请求分组时，就将自己的 IP 地址到硬件地址的映射写入 ARP 请求分组。当主机 B 收到 A 的 ARP 请求分组时，就将主机 A 的这一地址映射写入主机 B 自己的 ARP 高速缓存中。这对主机 B 以后向 A 发送数据报时就更方便了。 </p>
<p>如果目的主机不在本局域网呢</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415204653510.png" alt="image-20210415204653510"></p>
<p>ARP 用于解决同一个局域网上的主机或路由器的 IP 地址和硬件地址的映射问题。如果所要找的主机和源主机不在同一个局域网上，<strong>那么就要通过 ARP 找到一个位于本局域网上的某个路由器的硬件地址</strong>，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络。剩下的工作就由下一个网络来做。</p>
<p>从 IP 地址到硬件地址的解析是自动进行的，主机的用户对这种地址解析过程是不知道的。只要主机或路由器要和本网络上的另一个已知 IP 地址的主机或路由器进行通信，ARP 协议就会自动地将该 IP 地址解析为链路层所需要的硬件地址。 </p>
<p>最后，总结下使用ARP会遇到的四种典型情况</p>
<h3 id="不同应用场景"><a href="#不同应用场景" class="headerlink" title="不同应用场景"></a>不同应用场景</h3><ol>
<li><strong>发送方是主机</strong>，要把 IP 数据报发送到<strong>本网络上的另一个主机</strong>。这时用 ARP 找到目的主机的硬件地址。 </li>
<li>发送方是主机，要把 IP 数据报发送到<strong>另一个网络上的一个主机</strong>。这时用 ARP 找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成。 </li>
<li><strong>发送方是路由器</strong>，要把 IP 数据报转发到<strong>本网络上的一个主机</strong>。这时用 ARP 找到目的主机的硬件地址。 </li>
<li><strong>发送方是路由器</strong>，要把 IP 数据报转发到<strong>另一个网络上的一个主机</strong>。这时用 ARP 找到本网络上另一个路由器的硬件地址。剩下的工作由这个路由器来完成。 </li>
</ol>
<h3 id="为什么不直接使用硬件地址？"><a href="#为什么不直接使用硬件地址？" class="headerlink" title="为什么不直接使用硬件地址？"></a>为什么不直接使用硬件地址？</h3><p>由于全世界存在着各式各样的网络，它们使用不同的硬件地址。要使这些异构网络能够互相通信就必须进行非常复杂的硬件地址转换工作，因此几乎是不可能的事。想想看，若一台主机要跨交换机进行通信，那么他的数据是被无数个交换机所接收的，只有目的主机的交换机才会收下这部分数据，对比路由器，可以针对性对目标主机所在的局域网进行传递，至少不用像交换机一样进行广播，节省了多少资源，详细可以看看数据链路层的交换机工作方式，对比下路由器。</p>
<p>还有，调用 ARP 的复杂过程都是由计算机软件自动进行的，对用户来说是看不见这种调用过程的。因此，在虚拟的 IP 网络上用 IP 地址进行通信给广大的计算机用户带来了很大的方便。</p>
<h2 id="IP-数据报的格式"><a href="#IP-数据报的格式" class="headerlink" title="IP 数据报的格式"></a><strong>IP 数据报的格式</strong></h2><p>一个 IP 数据报由首部和数据两部分组成。首部的前一部分是固定长度，共 20 字节，是所有 IP 数据报必须具有的。在首部的固定部分的后面是一些可选字段，其长度是可变的。 </p>
<p>纵向来看</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415205509911.png" alt="image-20210415205509911"></p>
<p>横向简化版</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415205526556.png" alt="image-20210415205526556"></p>
<p>首部的前一部分是固定长度，共 <strong>20 字节</strong>，是所有 IP 数据报必须具有的。可选字段，其长度是可变的。</p>
<h3 id="IP-数据报首部的固定部分中的各字段"><a href="#IP-数据报首部的固定部分中的各字段" class="headerlink" title="IP 数据报首部的固定部分中的各字段"></a>IP 数据报首部的固定部分中的各字段</h3><ol>
<li><p>版本——占 4 位，指 IP 协议的版本。目前的 IP 协议版本号为 4 (即 IPv4)。</p>
</li>
<li><p>首部长度——占 4 位，可表示的最大数值是 15 个单位(一个单位为 4 字节)，因此 IP 的首部长度的最大值是 60 字节。</p>
</li>
<li><p>区分服务——占 8 位，用来获得更好的服务。在旧标准中叫做服务类型，但实际上一直未被使用过。1998 年这个字段改名为区分服务。只有在使用区分服务（DiffServ）时，这个字段才起作用。在一般的情况下都不使用这个字段 </p>
</li>
<li><p>总长度——占 16 位，指首部和数据之和的长度，单位为字节，因此数据报的最大长度为 65535 字节。总长度必须不超过最大传送单元MTU。 </p>
</li>
<li><p>标识(identification) ——占 16 位，它是一个计数器，用来产生 IP 数据报的标识。 </p>
</li>
<li><p><strong>标志(flag)</strong> ——占 3 位，目前只有前两位有意义。标志字段的最低位是 MF (More Fragment)。MF=1 表示后面“还有分片”。MF=0 表示最后一个分片。标志字段中间的一位是 DF (Don’t Fragment) 。只有当 DF=0 时才允许分片。 </p>
</li>
<li><p><strong>片偏移</strong>——占13 位，指出：较长的分组在分片后某片在原分组中的相对位置。片偏移以 8 个字节为偏移单位。</p>
</li>
<li><p><strong>生存时间</strong>——占8 位，记为 TTL (Time To Live)，指示数据报在网络中可通过的路由器数（也称跳数，最大值为255）的最大值。防止无法交付的数据报在互联网中无限制的兜圈子。</p>
</li>
<li><p>协议——占8 位，指出此数据报携带的数据使用何种协议，以便目的主机的 IP 层将数据部分上交给那个处理过程（在之后的运输层以及网络层会涉及到更多协议）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415212725311.png" alt="image-20210415212725311"></p>
</li>
<li><p>首部检验和——占16 位，只检验数据报的首部，不检验数据部分。这里不采用 CRC 检验码而采用简单的计算方法。 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415212818822.png" alt="image-20210415212818822"></p>
</li>
<li><p>源地址和目的地址都各占 4 字节</p>
</li>
</ol>
<p>其中，对于<strong>标志</strong>以及<strong>片偏移</strong>，这里通过一个例子加深理解</p>
<p>一数据报的总长度为 3820 字节，其数据部分的长度为 3800 字节（使用固定首部），需要分片为长度不超过 1420 字节的数据报片。<br>因固定首部长度为 20 字节，因此每个数据报片的数据部分长度不能超过 1400 字节。于是分为 3 个数据报片，其数据部分的长度分别为 1400、1400 和 1000 字节。<strong>原始数据报首部被复制为各数据报片的首部，但必须修改有关字段的值</strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415212526446.png" alt="image-20210415212526446"></p>
<p>IP 数据报首部中与分片有关的字段中的数值</p>
<table>
<thead>
<tr>
<th></th>
<th>总长度</th>
<th>标识</th>
<th>MF</th>
<th>DF</th>
<th>片偏移</th>
</tr>
</thead>
<tbody><tr>
<td>原始数据报</td>
<td>3820</td>
<td>12345</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>数据报片1</td>
<td>1420</td>
<td>12345</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>数据报片2</td>
<td>1420</td>
<td>12345</td>
<td>1</td>
<td>0</td>
<td>175</td>
</tr>
<tr>
<td>数据报片3</td>
<td>1020</td>
<td>12345</td>
<td>0</td>
<td>0</td>
<td>350</td>
</tr>
</tbody></table>
<h3 id="IP-数据报首部的可变部分"><a href="#IP-数据报首部的可变部分" class="headerlink" title="IP 数据报首部的可变部分"></a>IP 数据报首部的可变部分</h3><p>IP 首部的可变部分就是一个选项字段，用来支持<strong>排错、测量以及安全等</strong>措施，内容很丰富。选项字段的长度可变，<strong>从 1 个字节到 40 个字节不等</strong>，取决于所选择的项目。增加首部的可变部分是为了增加 IP 数据报的功能，但这同时也使得 IP 数据报的首部长度成为可变的。这就增加了每一个路由器处理数据报的开销。<strong>实际上这些选项很少被使用。</strong></p>
<h2 id="IP-层转发分组的流程"><a href="#IP-层转发分组的流程" class="headerlink" title="IP 层转发分组的流程"></a><strong>IP 层转发分组的流程</strong></h2><p>假设：有四个 A 类网络通过三个路由器连接在一起。每一个网络上都可能有成千上万个主机。可以想象，若按目的主机号来制作路由表，每一个路由表就有 4 万个项目，即 4 万行（每一行对应于一台主机），则所得出的路由表就会过于庞大。但若按主机所在的网络地址来制作路由表，那么每一个路由器中的路由表就只包含 4 个项目（每一行对应于一个网络），这样就可使路由表大大简化。 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415213715296.png" alt="image-20210415213715296"></p>
<p>在路由表中，对每一条路由，最主要的是（目的网络地址，下一跳地址） </p>
<h3 id="查找路由表"><a href="#查找路由表" class="headerlink" title="查找路由表"></a>查找路由表</h3><p>根据目的网络地址就能确定下一跳路由器，这样做的结果是：IP 数据报最终一定可以找到目的主机所在目的网络上的路由器（可能要通过多次的间接交付）。只有到达最后一个路由器时，才试图向目的主机进行直接交付。 </p>
<h3 id="特定主机路由"><a href="#特定主机路由" class="headerlink" title="特定主机路由"></a>特定主机路由</h3><p>虽然互联网所有的分组转发都是基于目的主机所在的网络，但在大多数情况下都允许有这样的特例，<strong>即为特定的目的主机指明一个路由</strong>。<br>采用特定主机路由可使网络管理人员能更方便地控制网络和测试网络，同时也可在需要考虑某种安全问题时采用这种特定主机路由。 </p>
<h3 id="默认路由-default-route"><a href="#默认路由-default-route" class="headerlink" title="默认路由 (default route)"></a>默认路由 (default route)</h3><p>路由器还可采用默认路由以减少路由表所占用的空间和搜索路由表所用的时间。这种转发方式在一个网络只有很少的对外连接时是很有用的。默认路由在主机发送 IP 数据报时往往更能显示出它的好处。如果一个主机连接在一个小网络上，而这个网络只用一个路由器和互联网连接，那么在这种情况下使用默认路由是非常合适的。 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415213953578.png" alt="image-20210415213953578"></p>
<p>只要目的网络不是 N1 和 N2，就一律选择默认路由，把数据报先间接交付路由器 R1，让 R1 再转发给下一个路由器。 </p>
<p>必须指出</p>
<p>IP 数据报的首部中没有地方可以用来指明“下一跳路由器的 IP 地址”。当路由器收到待转发的数据报，不是将下一跳路由器的 IP 地址填入 IP 数据报，而是送交下层的网络接口软件。网络接口软件<strong>使用 ARP</strong> 负责将下一跳路由器的 IP 地址转换成硬件地址，并将此硬件地址放在链路层的 MAC 帧的首部，然后根据这个硬件地址找到下一跳路由器。 </p>
<h3 id="路由器分组转发算法"><a href="#路由器分组转发算法" class="headerlink" title="路由器分组转发算法"></a>路由器分组转发算法</h3><ol>
<li>从数据报的首部提取目的主机的 IP 地址 D, 得出目的网络地址为 N。</li>
<li>若网络 N 与此路由器直接相连，则把数据报直接交付目的主机 D；否则是间接交付，执行 (3)。</li>
<li>若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行 (4)。</li>
<li>若路由表中有到达网络 N 的路由，则把数据报传送给路由表指明的下一跳路由器；否则，执行 (5)。</li>
<li>若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行 (6)。</li>
<li>报告转发分组出错。 </li>
</ol>
<p>最后，总结一下路由表：路由表没有给分组指明到某个网络的完整路径。路由表指出，到某个网络应当先到某个路由器（即下一跳路由器）。在到达下一跳路由器后，再继续查找其路由表，知道再下一步应当到哪一个路由器。这样一步一步地查找下去，直到最后到达目的网络。</p>
<h1 id="划分子网和构造超网"><a href="#划分子网和构造超网" class="headerlink" title="划分子网和构造超网"></a><strong>划分子网和构造超网</strong></h1><h2 id="划分子网"><a href="#划分子网" class="headerlink" title="划分子网"></a>划分子网</h2><p>两级IP地址到三级IP地址（了解）</p>
<p>一开始是只有网络号和主机号的，为了方便管理，就出现了下面的地址形式</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415215744413.png" alt="image-20210415215744413"></p>
<blockquote>
<p>IP地址 ::= {&lt;网络号&gt;, &lt;子网号&gt;, &lt;主机号&gt;}</p>
</blockquote>
<p>划分子网思路如下</p>
<p>划分子网纯属一个<strong>单位内部的事情</strong>。单位对外仍然表现为没有划分子网的网络。从主机号借用若干个位作为子网号 subnet-id，而主机号 host-id 也就相应减少了若干个位。</p>
<p>凡是从其他网络发送给本单位某个主机的 IP 数据报，仍然是根据 IP 数据报的目的网络号 net-id，先找到连接在本单位网络上的路由器。<br>然后此路由器在收到 IP 数据报后，再按目的网络号 net-id 和子网号 subnet-id 找到目的子网。最后就将 IP 数据报直接交付目的主机。</p>
<p> 一个未划分子网的 B 类网络145.13.0.0（下图）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415220031670.png" alt="image-20210415220031670"></p>
<p>划分为三个子网，它对外仍是一个网络</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415220105427.png" alt="image-20210415220105427"></p>
<p>当没有划分子网时，IP 地址是两级结构。划分子网后 IP 地址就变成了三级结构。划分子网只是把 IP 地址的<strong>主机号 host-id 这部分进行再划分</strong>，而不改变 IP 地址原来的网络号 net-id。 </p>
<p>划分后的三级结构子网有什么优点呢</p>
<ol>
<li>减少了 IP 地址的浪费</li>
<li>使网络的组织更加灵活</li>
<li>更便于维护和管理</li>
</ol>
<p>划分子网纯属一个单位内部的事情，对外部网络透明，对外仍然表现为没有划分子网的一个网络。</p>
<h3 id="子网掩码"><a href="#子网掩码" class="headerlink" title="子网掩码"></a>子网掩码</h3><p>从一个 IP 数据报的首部并无法判断源主机或目的主机所连接的网络是否进行了子网划分。使用子网掩码 (subnet mask) 可以找出 IP 地址中的子网部分。  </p>
<p>规则：子网掩码长度 ＝ 32 位；子网掩码左边部分的一连串 1，对应于网络号和子网号；子网掩码右边部分的一连串 0，对应于主机号</p>
<p>也就是说，把设定的子网号包括网络号全部置为1，后面的全为0，代表分配给主机号 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415220909881.png" alt="image-20210415220909881"></p>
<p>很恨很重要的一条公式</p>
<blockquote>
<p><strong>(IP 地址) AND (子网掩码) =网络地址</strong></p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415221001845.png" alt="image-20210415221001845"></p>
<p>默认的子网掩码（下图）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415221114137.png" alt="image-20210415221114137"></p>
<p>子网掩码是一个网络或一个子网的重要属性。路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器。路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码。若一个路由器连接在两个子网上，就拥有两个网络地址和两个子网掩码。</p>
<h3 id="子网划分方法"><a href="#子网划分方法" class="headerlink" title="子网划分方法"></a>子网划分方法</h3><p>有<strong>固定长度子网</strong>和<strong>变长子网</strong>两种子网划分方法。</p>
<p>在采用固定长度子网时，所划分的所有子网的子网掩码都是相同的。<br>虽然根据已成为互联网标准协议的 RFC 950 文档，子网号不能为全 1 或全 0，但随着[<strong>无分类域间路由选择 CIDR</strong>](#无分类编址 CIDR（构造超网）) 的广泛使用，现在全 1 和全 0 的子网号也可以使用了，但一定要谨慎使用，确认你的路由器所用的路由选择软件是否支持全 0 或全 1 的子网号这种较新的用法。</p>
<p>划分子网增加了灵活性，但却减少了能够连接在网络上的主机总数。</p>
<p>B 类地址的子网划分选择（使用固定长度子网），如下图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415221507099.png" alt="image-20210415221507099"></p>
<p>表中的“子网号的位数”中没有 0, 1, 15 和 16 这四种情况，因为这没有意义。 </p>
<p><strong>来啦来啦，计算题来啦</strong></p>
<p>【例4-2】已知 IP 地址是 141.14.72.24，子网掩码是255.255.224.0。试求网络地址。 </p>
<p>解题思路图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415221801814.png" alt="image-20210415221801814"></p>
<p>【例4-3】上例中，若子网掩码改为 255.255.224.0，试求网络地址，讨论所得结果。 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415221850867.png" alt="image-20210415221850867"></p>
<p>通过解题发现了啥，不同的子网掩码对同一个ip地址得出相同的网络地址，但实际上不同的掩码的效果是不同的，这对后面学习无分类编址CIDR很重要，当对一个ip地址进行掩码处理后，你会发现可能多个网络号都对应得上，那么我们往往会选择更大的那一个，因为离得更近嘛。</p>
<h2 id="使用子网时分组的转发"><a href="#使用子网时分组的转发" class="headerlink" title="使用子网时分组的转发"></a>使用子网时分组的转发</h2><p>在不划分子网的两级 IP 地址下，从 IP 地址得出网络地址是个很简单的事。但在划分子网的情况下，从 IP 地址却不能唯一地得出网络地址来，这是因为网络地址取决于那个网络所采用的子网掩码，但数据报的首部并没有提供子网掩码的信息。因此分组转发的算法也必须做相应的改动。 看看改动后的算法是怎样的</p>
<ol>
<li>从收到的分组的首部提取<strong>目的 IP 地址 D</strong>。</li>
<li>先用各网络的<strong>子网掩码和 D 逐位相“与”</strong>，看是否和相应的网络地址匹配。若匹配，则将分组直接交付。否则就是间接交付，执行(3)。</li>
<li>若路由表中有目的地址为 D 的<strong>特定主机路由</strong>，则将分组传送给指明的下一跳路由器；否则，执行 (4)。</li>
<li>对路由表中的每一行，将<strong>子网掩码和 D 逐位相“与”</strong>。若结果与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器；否则，执行 (5)。</li>
<li>若路由表中有一个<strong>默认路由</strong>，则将分组传送给路由表中所指明的默认路由器；否则，执行 (6)。</li>
<li>报告转发分组出错。</li>
</ol>
<p>再来一题</p>
<p>【例4-4】已知互联网和路由器 R1 中的路由表。主机 H1 向 H2 发送分组。试讨论 R1 收到 H1 向 H2 发送的分组后查找路由表的过程。 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415222745188.png" alt="image-20210415222745188"></p>
<p>H1 首先检查主机 128.30.33.138 是否连接在本网络上，如果是，则直接交付；否则，就送交路由器 R1，并逐项查找路由表。</p>
<p>主机 H1 首先将本子网的子网掩码 255.255.255.128与分组的 IP 地址 128.30.33.138 逐比特相与”(AND 操作) </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210415223100270.png" alt="image-20210415223100270"></p>
<p>因此 H1 必须把分组传送到路由器 R1，然后逐项查找路由表</p>
<p>路由器 R1 收到分组后就用路由表中第 1 个项目的子网掩码和 128.30.33.138 逐比特 AND 操作 ，然后如此下去，直到得出的网络地址和路由表中子网掩码的对应目的网络地址匹配</p>
<p>255.255.255.128 AND 128.30.33.138 = 128.30.33.128     不匹配!<br>（因为128.30.33.128 与路由表中的 128.30.33.0 不一致）</p>
<p>255.255.255.128 AND 128.30.33.138 = 128.30.33.128     匹配!<br>这表明子网 2 就是收到的分组所要寻找的目的网络。</p>
<h2 id="无分类编址-CIDR（构造超网）"><a href="#无分类编址-CIDR（构造超网）" class="headerlink" title="无分类编址 CIDR（构造超网）"></a>无分类编址 CIDR（构造超网）</h2><p>为了解决B 类地址分配快完的以及互联网主干网上的路由表中的项目数急剧增长（从几千个增长到几万个）的问题。</p>
<p>使用<strong>变长子网掩码 VLSM</strong> (Variable Length Subnet Mask)可进一步提高 IP 地址资源的利用率。</p>
<p>在 VLSM 的基础上又进一步研究出无分类编址方法，它的正式名字是<strong>无分类域间路由选择 CIDR</strong> (Classless Inter-Domain Routing)。</p>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul>
<li>CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，因而可以更加有效地分配 IPv4 的地址空间。</li>
<li>CIDR使用各种长度的“网络前缀”(network-prefix)来代替分类地址中的网络号和子网号。</li>
<li>IP 地址从三级编址（使用子网掩码）又回到了两级编址。 </li>
</ul>
<p>无分类的两级编址的记法是</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416072608149.png" alt="image-20210416072608149"></p>
<blockquote>
<p>IP地址 ::= {&lt;网络前缀&gt;, &lt;主机号&gt;}</p>
</blockquote>
<p>为了同三级编址一样划分子网，CIDR 使用<strong>“斜线记法”(slash notation)</strong>，它又称为 CIDR 记法，即在 IP 地址里面加上一个<strong>斜线“/”</strong>，然后<strong>写上网络前缀所占的位数</strong>（这个数值对应于三级编址中子网掩码中 1 的个数）。例如： 220.78.168.0/24</p>
<h3 id="CIDR-地址块"><a href="#CIDR-地址块" class="headerlink" title="CIDR 地址块"></a>CIDR 地址块</h3><blockquote>
<p>CIDR 把网络前缀都相同的连续的 IP 地址组成“CIDR 地址块”。</p>
</blockquote>
<p>128.14.32.0/20 表示的地址块共有 212 个地址（因为斜线后面的 20 是网络前缀的位数，所以这个地址的主机号是 12 位）。</p>
<p>这个地址块的起始地址是 128.14.32.0。</p>
<p>在不需要指出地址块的起始地址时，也可将这样的地址块简称为“/20 地址块”。</p>
<p>128.14.32.0/20 地址块的最小地址：128.14.32.0</p>
<p>128.14.32.0/20 地址块的最大地址：128.14.47.255</p>
<h4 id="其他形式的记法"><a href="#其他形式的记法" class="headerlink" title="其他形式的记法"></a>其他形式的记法</h4><p>10.0.0.0/10 可简写为 10/10，也就是把点分十进制中低位连续的 0 省略。<br>10.0.0.0/10 隐含地指出 IP 地址 10.0.0.0 的掩码 255.192.0.0。此掩码可表示为：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416073332167.png" alt="image-20210416073332167"></p>
<p>网络前缀的后面加一个星号 * 的表示方法，如 00001010 00*，在星号 * 之前是网络前缀，而星号 * 表示 IP 地址中的主机号，可以是任意值。 </p>
<p><strong>注意：全 0 和全 1 的主机号地址一般不使用。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416072842853.png" alt="image-20210416072842853"></p>
<h3 id="路由聚合-route-aggregation"><a href="#路由聚合-route-aggregation" class="headerlink" title="路由聚合 (route aggregation)"></a>路由聚合 (route aggregation)</h3><p>一个 CIDR 地址块可以表示很多地址，这种地址的聚合常称为路由聚合，它使得路由表中的一个项目可以表示很多个（例如上千个）原来传统分类地址的路由。路由聚合有利于减少路由器之间的路由选择信息的交换，从而提高了整个互联网的性能。<strong>路由聚合也称为构成超网 (supernetting)。</strong></p>
<p>简单来说，就是将一部分具有相同网络前缀以及掩码的地址聚合成一个整体</p>
<p>CIDR 虽然不使用子网了，但仍然使用“掩码”这一名词（但不叫子网掩码）。对于 /20  地址块，它的掩码是 20 个连续的 1。 斜线记法中的数字就是掩码中1的个数。 </p>
<p><strong>常用的CIDR地址块</strong></p>
<table>
<thead>
<tr>
<th>CIDR 前缀长度</th>
<th>点分十进制</th>
<th>包含的地址数</th>
<th>相当于包含分类的网络数</th>
</tr>
</thead>
<tbody><tr>
<td>/13</td>
<td>255.248.0.0</td>
<td>512 K</td>
<td>8 个   B类或  2048 个 C  类</td>
</tr>
<tr>
<td>/14</td>
<td>255.252.0.0</td>
<td>256 K</td>
<td>4 个 B  类或1024 个 C  类</td>
</tr>
<tr>
<td>/15</td>
<td>255.254.0.0</td>
<td>128 K</td>
<td>2 个 B  类或512 个 C  类</td>
</tr>
<tr>
<td>/16</td>
<td>255.255.0.0</td>
<td>64 K</td>
<td>1 个 B  类或256 个 C  类</td>
</tr>
<tr>
<td>/17</td>
<td>255.255.128.0</td>
<td>32 K</td>
<td>128 个 C  类</td>
</tr>
<tr>
<td>/18</td>
<td>255.255.192.0</td>
<td>16 K</td>
<td>64 个 C  类</td>
</tr>
<tr>
<td>/19</td>
<td>255.255.224.0</td>
<td>8 K</td>
<td>32 个 C  类</td>
</tr>
<tr>
<td>/20</td>
<td>255.255.240.0</td>
<td>4 K</td>
<td>16 个 C  类</td>
</tr>
<tr>
<td>/21</td>
<td>255.255.248.0</td>
<td>2 K</td>
<td>8 个 C  类</td>
</tr>
<tr>
<td>/22</td>
<td>255.255.252.0</td>
<td>1 K</td>
<td>4 个 C  类</td>
</tr>
<tr>
<td>/23</td>
<td>255.255.254.0</td>
<td>512</td>
<td>2 个 C  类</td>
</tr>
<tr>
<td>/24</td>
<td>255.255.255.0</td>
<td>256</td>
<td>1 个 C  类</td>
</tr>
<tr>
<td>/25</td>
<td>255.255.255.128</td>
<td>128</td>
<td>1/4 个 C  类</td>
</tr>
<tr>
<td>/26</td>
<td>255.255.255.192</td>
<td>64</td>
<td>1/4 个 C  类</td>
</tr>
<tr>
<td>/27</td>
<td>255.255.255.224</td>
<td>32</td>
<td>1/8 个 C  类</td>
</tr>
</tbody></table>
<p>前缀长度不超过 23 位的 CIDR 地址块都包含了多个 C  类地址。这些 C 类地址合起来就<strong>构成了超网</strong>。<strong>CIDR 地址块中的地址数一定是 2 的整数次幂</strong>。网络前缀越短，其地址块所包含的地址数就越多。而在<strong>三级结构的IP地址中，划分子网是使网络前缀变长</strong>。</p>
<p>CIDR 的一个好处是：可以更加有效地分配 IPv4 的地址空间，可根据客户的需要分配适当大小的 CIDR 地址块。 </p>
<p>比如下面的例子</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416073719888.png" alt="image-20210416073719888"></p>
<p>这个 ISP 共有 64 个 C 类网络。如果不采用 CIDR 技术，则在与该 ISP 的路由器交换路由信息的每一个路由器的路由表中，就需要有 64 个项目。但采用地址聚合后，只需用路由聚合后的 1 个项目 206.0.64.0/18 就能找到该 ISP。</p>
<h3 id="最长前缀匹配"><a href="#最长前缀匹配" class="headerlink" title="最长前缀匹配"></a>最长前缀匹配</h3><p>使用 CIDR 时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成。在查找路由表时可能会得到不止一个匹配结果。 应当从匹配结果中选择具有最长网络前缀的路由：最长前缀匹配 (longest-prefix matching)。网络前缀越长，其地址块就越小，因而路由就越具体 (more specific) 。<strong>最长前缀匹配又称为最长匹配或最佳匹配。</strong></p>
<p>比如</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416073906784.png" alt="image-20210416073906784"></p>
<p>接着</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416073927958.png" alt="image-20210416073927958"></p>
<p>怎么选择呢，当然就是选择两个匹配的地址中更具体的一个，即选择最长前缀的地址。 这样就能更具体更快的找到主机所在网络啦</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416074031309.png" alt="image-20210416074031309"></p>
<h3 id="使用二叉线索查找路由表"><a href="#使用二叉线索查找路由表" class="headerlink" title="使用二叉线索查找路由表"></a>使用二叉线索查找路由表</h3><p>当路由表的项目数很大时，怎样设法减小路由表的查找时间就成为一个非常重要的问题。 为了进行更加有效的查找，通常是将无分类编址的路由表存放在一种<strong>层次的数据结构中，然后自上而下地按层次进行查找</strong>。这里最常用的就是二叉线索 (binary trie)。</p>
<p>IP 地址中从左到右的比特值决定了从根结点逐层向下层延伸的路径，而二叉线索中的各个路径就代表路由表中存放的各个地址。<br>为了提高二叉线索的查找速度，广泛使用了各种压缩技术。 </p>
<p>如下面的例子</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416074305521.png" alt="image-20210416074305521"></p>
<p>从二叉线索的根节点自顶向下的深度最多有 32 层，每一层对应于IP地址中的一位。一个IP地址存入二叉线索的规则很简单。先检查IP地址左边的第一位，如为 0，则第一层的节点就在根节点的左下方；如为 1，则在右下方。然后再检查地址的第二位，构造出第二层的节点。依此类推，直到唯一前缀的最后一位。</p>
<h1 id="网际控制报文协议-ICMP"><a href="#网际控制报文协议-ICMP" class="headerlink" title="网际控制报文协议 ICMP"></a><strong>网际控制报文协议 ICMP</strong></h1><h2 id="ICMP-报文的种类"><a href="#ICMP-报文的种类" class="headerlink" title="ICMP 报文的种类"></a>ICMP 报文的种类</h2><p>为了更有效地转发 IP 数据报和提高交付成功的机会，在网际层使用了网际控制报文协议 ICMP (Internet Control Message Protocol)。ICMP 是互联网的标准协议。</p>
<p>ICMP 允许<strong>主机或路由器报告差错情况和提供有关异常情况的报告</strong>。但 ICMP 不是高层协议（看起来好像是高层协议，因为 ICMP 报文是装在 IP 数据报中，作为其中的数据部分），而是 IP 层的协议。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416082346847.png" alt="image-20210416082346847"></p>
<p>ICMP 报文的种类有两种，即 <strong>ICMP 差错报告报文</strong>和 <strong>ICMP 询问报文</strong>。 ICMP 报文的前 4 个字节是统一的格式，共有三个字段：即<strong>类型、代码和检验和</strong>。接着的 4 个字节的内容与 ICMP 的类型有关。 </p>
<h3 id="ICMP-差错报告报文"><a href="#ICMP-差错报告报文" class="headerlink" title="ICMP 差错报告报文"></a>ICMP 差错报告报文</h3><p>ICMP 差错报告报文共有 4 种</p>
<ul>
<li>终点不可达 </li>
<li>时间超过 </li>
<li>参数问题 </li>
<li>改变路由（重定向）(Redirect) </li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416082743895.png" alt="image-20210416082743895"></p>
<p>有几种情况不会发送ICMP差错报告报文</p>
<ol>
<li>对 ICMP 差错报告报文不再发送 ICMP 差错报告报文。</li>
<li>对<strong>第一个分片的数据报片的所有后续数据报片</strong>都不发送 ICMP 差错报告报文。</li>
<li>对具有<strong>多播地址</strong>的数据报都不发送 ICMP 差错报告报文。</li>
<li>对具有<strong>特殊地址</strong>（如127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP 差错报告报文。</li>
</ol>
<h3 id="ICMP-询问报文"><a href="#ICMP-询问报文" class="headerlink" title="ICMP 询问报文"></a>ICMP 询问报文</h3><p>ICMP 询问报文有两种</p>
<ol>
<li>回送请求和回答报文</li>
<li>时间戳请求和回答报文</li>
</ol>
<h2 id="ICMP-的应用举例"><a href="#ICMP-的应用举例" class="headerlink" title="ICMP 的应用举例"></a>ICMP 的应用举例</h2><h3 id="PING-Packet-InterNet-Groper"><a href="#PING-Packet-InterNet-Groper" class="headerlink" title="PING (Packet InterNet Groper)"></a>PING (Packet InterNet Groper)</h3><p>PING 用来测试两个主机之间的连通性。PING 使用了 <strong>ICMP 回送请求与回送回答报文</strong>。PING 是应用层直接使用网络层 ICMP 的例子，它没有通过运输层的 TCP 或UDP。 </p>
<p>下图是用 PING 测试主机的连通性</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416083452619.png" alt="image-20210416083452619"></p>
<h3 id="Traceroute"><a href="#Traceroute" class="headerlink" title="Traceroute"></a>Traceroute</h3><p>在 Windows 操作系统中这个命令是 tracert。它用来<strong>跟踪一个分组从源点到终点的路径</strong>。它利用 IP 数据报中的 <strong>TTL 字段</strong>和 <strong>ICMP 时间超过差错报告报文</strong>实现对从源点到终点的路径的跟踪。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416084136437.png" alt="image-20210416084136437"></p>
<p>用 tracert 命令获得到目的主机的路由信息</p>
<h1 id="互联网的路由选择协议"><a href="#互联网的路由选择协议" class="headerlink" title="互联网的路由选择协议"></a><strong>互联网的路由选择协议</strong></h1><h2 id="有关路由选择协议的几个基本概念"><a href="#有关路由选择协议的几个基本概念" class="headerlink" title="有关路由选择协议的几个基本概念"></a>有关路由选择协议的几个基本概念</h2><h3 id="理想的路由算法"><a href="#理想的路由算法" class="headerlink" title="理想的路由算法"></a>理想的路由算法</h3><p>算法必须是正确的和完整的。 在计算上应简单。 应能适应通信量和网络拓扑的变化，这就是说，要有自适应性。 应具有稳定性。应是公平的。应是最佳的。 </p>
<p>不存在一种绝对的最佳路由算法。所谓“最佳”只能是相对于某一种特定要求下得出的较为合理的选择而已。 </p>
<p><strong>静态</strong>路由选择策略——即<strong>非自适应路由选择</strong>，其特点是简单和开销较小，但不能及时适应网络状态的变化。 </p>
<p><strong>动态</strong>路由选择策略——即<strong>自适应路由选择</strong>，其特点是能较好地适应网络状态的变化，但实现起来较为复杂，开销也比较大。 </p>
<h3 id="分层次的路由选择协议"><a href="#分层次的路由选择协议" class="headerlink" title="分层次的路由选择协议"></a>分层次的路由选择协议</h3><p>互联网采用分层次的路由选择协议。这是因为：</p>
<p>(1) 互联网的规模非常大。如果让所有的路由器知道所有的网络应怎样到达，则这种路由表将非常大，处理起来也太花时间。而所有这些路由器之间交换路由信息所需的带宽就会使互联网的通信链路饱和。</p>
<p>(2) 许多单位不愿意外界了解自己单位网络的布局细节和本部门所采用的路由选择协议（这属于本部门内部的事情），但同时还希望连接到互联网上。 </p>
<h4 id="自治系统-AS"><a href="#自治系统-AS" class="headerlink" title="自治系统 AS"></a>自治系统 AS</h4><p><strong>自治系统 AS 的定义：</strong>在单一的技术管理下的一组路由器，而这些路由器使用一种 AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议用以确定分组在 AS之间的路由。</p>
<p>现在对自治系统 AS 的定义是强调下面的事实：尽管一个 AS 使用了多种内部路由选择协议和度量，但重要的是<strong>一个 AS 对其他 AS 表现出的是一个单一的和一致的路由选择策略</strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416090330427.png" alt="image-20210416090330427"></p>
<h4 id="内部网关协议-IGP-Interior-Gateway-Protocol"><a href="#内部网关协议-IGP-Interior-Gateway-Protocol" class="headerlink" title="内部网关协议 IGP (Interior Gateway Protocol)"></a>内部网关协议 IGP (Interior Gateway Protocol)</h4><p>在一个自治系统内部使用的路由选择协议。目前这类路由选择协议使用得最多，如 RIP 和 OSPF 协议。</p>
<h4 id="外部网关协议-EGP-External-Gateway-Protocol"><a href="#外部网关协议-EGP-External-Gateway-Protocol" class="headerlink" title="外部网关协议 EGP (External Gateway Protocol)"></a>外部网关协议 EGP (External Gateway Protocol)</h4><p>若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议将路由选择信息传递到另一个自治系统中。这样的协议就是外部网关协议 EGP。在外部网关协议中目前使用最多的是 BGP-4。 </p>
<p>它们之间的关系可以用下面的图来表示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416090740503.png" alt="image-20210416090740503"></p>
<p>还有两个概念要知道</p>
<blockquote>
<p>自治系统之间的路由选择也叫做<strong>域间路由选择</strong> (interdomain routing)，在自治系统内部的路由选择叫做<strong>域内路由选择</strong> (intradomain routing) 。</p>
</blockquote>
<blockquote>
<p>互联网的早期 RFC 文档中未使用“路由器”而是使用“网关”这一名词。但是在新的 RFC 文档中又使用了“路由器”这一名词。应当把这两个术语当作同义词</p>
</blockquote>
<h2 id="内部网关协议-RIP"><a href="#内部网关协议-RIP" class="headerlink" title="内部网关协议 RIP"></a>内部网关协议 RIP</h2><h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><p>路由信息协议 RIP (Routing Information Protocol) 是内部网关协议 IGP 中最先得到广泛使用的协议。RIP 是一种<strong>分布式的、基于距离向量的路由选择协议</strong>。<strong>RIP 协议</strong>要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录。 </p>
<blockquote>
<p>这里的“距离”不是咱们普通的单位量算，而是路由器到直接相连的网络的距离（也就是跳数）</p>
<p>从一个路由器到直接连接的网络的距离定义为 1。从一个路由器到非直接连接的网络的距离定义为所经过的路由器数加 1。RIP 协议中的“距离”也称为“跳数”(hop count)，因为每经过一个路由器，跳数就加 1。这里的“距离”实际上指的是“最短距离”。 </p>
</blockquote>
<p>RIP 认为一个好的路由就是它通过的路由器的数目少，即“距离短”。<br>RIP 允许<strong>一条路径最多只能包含 15 个路由器</strong>。</p>
<p><strong>“距离”的最大值为 16 时即相当于不可达</strong>。可见 RIP 只适用于小型互联网。</p>
<p>RIP <strong>不能在两个网络之间同时使用多条路由</strong>。RIP 选择一个具有最少路由器的路由（即最短路由），哪怕还存在另一条高速(低时延)但路由器较多的路由。 </p>
<h3 id="特点-1"><a href="#特点-1" class="headerlink" title="特点"></a>特点</h3><ol>
<li>仅和相邻路由器交换信息。 </li>
<li>交换的信息是当前本路由器所知道的全部信息，即自己的路由表。 </li>
<li>按固定的时间间隔交换路由信息，例如，每隔 30 秒。当网络拓扑发生变化时，路由器也及时向相邻路由器通告拓扑变化后的路由信息。</li>
</ol>
<h3 id="工作过程（路由表的建立）"><a href="#工作过程（路由表的建立）" class="headerlink" title="工作过程（路由表的建立）"></a>工作过程（路由表的建立）</h3><p>路由器在刚刚开始工作时，只知道到直接连接的网络的距离（此距离定义为 1）。它的路由表是空的。以后，每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址。</p>
<blockquote>
<p>RIP 协议的<strong>收敛 (convergence)</strong> 过程较快。“收敛”就是在自治系统中所有的结点都得到正确的路由选择信息的过程。 </p>
</blockquote>
<h3 id="距离量算法"><a href="#距离量算法" class="headerlink" title="距离量算法"></a>距离量算法</h3><p>完整算法流程如下图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416091523557.png" alt="image-20210416091523557"></p>
<p>距离向量算法的基础就是 Bellman-Ford 算法（或 Ford-Fulkerson 算法）。这种算法的要点是这样的：设X是结点 A 到 B 的最短路径上的一个结点。若把路径 A→B 拆成两段路径 A→X 和 X→B，则每一段路径 A→X 和 X→B 也都分别是结点 A 到 X 和结点 X 到 B 的最短路径。</p>
<p>RIP 协议让互联网中的所有路由器都和自己的相邻路由器不断交换路由信息，并不断更新其路由表，使得从每一个路由器到每一个目的网络的路由都是最短的（即跳数最少）。</p>
<p>虽然所有的路由器最终都拥有了整个自治系统的全局路由信息，但由于每一个路由器的位置不同，它们的路由表当然也应当是不同的。</p>
<p>例题又来啦 </p>
<p>下图为路由表更新的一个例子以及解题过程<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416092004254.png" alt="image-20210416092004254"></p>
<h3 id="RIP2-协议的报文格式"><a href="#RIP2-协议的报文格式" class="headerlink" title="RIP2 协议的报文格式"></a>RIP2 协议的报文格式</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416092103127.png" alt="image-20210416092103127"></p>
<p>RIP2 报文由首部和路由部分组成。RIP2 报文中的路由部分由若干个路由信息组成。每个路由信息需要用 <strong>20 个字节</strong>。<strong>地址族标识符（又称为地址类别）字段</strong>用来标志所使用的地址协议。<strong>路由标记</strong>填入自治系统的号码，这是考虑使 RIP 有可能收到本自治系统以外的路由选择信息。再后面指出某个网络地址、该网络的子网掩码、下一跳路由器地址以及到此网络的距离。 </p>
<p>一个 RIP 报文最多可包括 <strong>25 个路由</strong>，因而 RIP 报文的最大长度是 4+20 x25=504 字节。如超过，必须再用一个 RIP 报文来传送。</p>
<p><strong>RIP2 具有简单的鉴别功能。</strong><br>若使用鉴别功能，则将原来写入第一个路由信息（20 个字节）的位置用作鉴别。在鉴别数据之后才写入路由信息，但这时最多只能再放入 24 个路由信息。</p>
<p><strong>RIP 协议特点：好消息传播得快，坏消息传播得慢</strong>。<br><strong>RIP 存在的一个问题：</strong>当网络出现故障时，要经过比较长的时间 (例如数分钟) 才能将此信息传送到所有的路由器。通过多图小漫画来了解该过程</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416092825114.png" alt="image-20210416092825114"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416092839477.png" alt="image-20210416092839477"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416092854326.png" alt="image-20210416092854326"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416092911949.png" alt="image-20210416092911949"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416092923117.png" alt="image-20210416092923117"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416092941221.png" alt="image-20210416092941221"></p>
<p>这就是好消息传播得快，而坏消息传播得慢。网络出故障的传播时间往往需要较长的时间(例如数分钟)。这是 RIP 的一个主要缺点。 </p>
<h3 id="RIP-协议的优缺点"><a href="#RIP-协议的优缺点" class="headerlink" title="RIP 协议的优缺点"></a>RIP 协议的优缺点</h3><p><strong>优点</strong>：</p>
<ol>
<li>实现简单，开销较小。</li>
</ol>
<p><strong>缺点</strong>：</p>
<ol>
<li>RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）。</li>
<li>路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加。 </li>
<li>“坏消息传播得慢”，使更新过程的收敛时间过长。</li>
</ol>
<h2 id="内部网关协议-OSPF"><a href="#内部网关协议-OSPF" class="headerlink" title="内部网关协议 OSPF"></a>内部网关协议 OSPF</h2><p>开放最短路径优先 OSPF (Open Shortest Path First)是为克服 RIP 的缺点在 1989 年开发出来的。OSPF 的原理很简单，但实现起来却较复杂。</p>
<h3 id="特点-2"><a href="#特点-2" class="headerlink" title="特点"></a>特点</h3><p>“开放”表明 OSPF 协议不是受某一家厂商控制，而是公开发表的。</p>
<p>“最短路径优先”是因为使用了 Dijkstra 提出的最短路径算法 SPF</p>
<p>采用分布式的链路状态协议 (link state protocol)。 </p>
<blockquote>
<p>注意：OSPF 只是一个协议的名字，它并不表示其他的路由选择协议不是“最短路径优先”。</p>
</blockquote>
<p>OSPF 规定每隔一段时间，如 30 分钟，要刷新一次<strong>数据库中的链路状态</strong>。 </p>
<p>由于一个路由器的链路状态只涉及到与<strong>相邻路由器的连通状态</strong>，因而与整个互联网的规模并无直接关系。因此当互联网规模很大时，OSPF  协议要比距离向量协议 RIP 好得多。 </p>
<p>OSPF 没有“坏消息传播得慢”的问题，据统计，其响应网络变化的时间小于 100 ms。 </p>
<h3 id="工作方式"><a href="#工作方式" class="headerlink" title="工作方式"></a>工作方式</h3><p>向本自治系统中所有路由器发送信息，这里使用的方法是<strong>洪泛法</strong>。发送的信息就是与本路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息。<strong>“链路状态”就是说明本路由器都和哪些路由器相邻，以及该链路的“度量”(metric)。</strong>只有当链路状态发生变化时，路由器才用洪泛法向所有路由器发送此信息。 </p>
<p>由于各路由器之间频繁地交换链路状态信息，因此所有的路由器最终都能建立一个链路状态数据库。这个数据库实际上就是<strong>全网的拓扑结构图</strong>，它在全网范围内是一致的（这称为链路状态数据库的同步）。</p>
<p>OSPF 的链路状态数据库能较快地进行更新，使各个路由器能及时更新其路由表。OSPF 的更新过程收敛得快是其重要优点。</p>
<p>为了使 OSPF 能够用于规模很大的网络，OSPF 将一个自治系统再划分为若干个更小的范围，叫做区域。每一个区域都有一个 32 位的区域标识符（用点分十进制表示）。区域也不能太大，在一个区域内的路由器最好不超过 200 个。 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416093937924.png" alt="image-20210416093937924"></p>
<p>划分区域的好处就是将利用洪泛法交换链路状态信息的范围局限于每一个区域而不是整个的自治系统，这就减少了整个网络上的通信量。</p>
<p><strong>在一个区域内部的路由器只知道本区域的完整网络拓扑，而不知道其他区域的网络拓扑的情况。</strong>OSPF 使用<strong>层次结构的区域划分</strong>。在上层的区域叫做主干区域 (backbone area)。主干区域的标识符规定为0.0.0.0。主干区域的作用是用来连通其他在下层的区域。 </p>
<p>其中：R3、R4、R7为边界路由器，R5、R6为主干路由器</p>
<h3 id="OSPF-直接用-IP-数据报传送"><a href="#OSPF-直接用-IP-数据报传送" class="headerlink" title="OSPF 直接用 IP 数据报传送"></a>OSPF 直接用 IP 数据报传送</h3><p>OSPF 不用 UDP 而是直接用 IP 数据报传送。</p>
<p>OSPF 构成的<strong>数据报很短</strong>。这样做可<strong>减少路由信息的通信量</strong>。数据报很短的另一好处是可以不必将长的数据报分片传送。而分片传送的数据报只要丢失一个，就无法组装成原来的数据报，而整个数据报就必须重传。 </p>
<h3 id="负载平衡"><a href="#负载平衡" class="headerlink" title="负载平衡"></a>负载平衡</h3><p>OSPF 对不同的链路可根据 IP 分组的不同服务类型 TOS 而设置成不同的代价。因此，OSPF 对于不同类型的业务可计算出不同的路由。</p>
<p>如果到同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路径。这叫做多路径间的<strong>负载平衡</strong>。</p>
<p>所有在 OSPF 路由器之间交换的分组都具有鉴别的功能。<strong>支持可变长度的子网划分和无分类编址 CIDR。</strong>每一个链路状态都带上一个 32 位的序号，<strong>序号越大状态就越新</strong>。</p>
<h3 id="OSPF-分组"><a href="#OSPF-分组" class="headerlink" title="OSPF 分组"></a>OSPF 分组</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416112557225.png" alt="image-20210416112557225"></p>
<p>OSPF <strong>的五种分组类型</strong></p>
<p>类型1，问候 (Hello) 分组。<br>类型2，数据库描述 (Database Description) 分组。<br>类型3，链路状态请求 (Link State Request) 分组。<br>类型4，链路状态更新 (Link State Update) 分组，用洪泛法对全网更新链路状态。<br>类型5，链路状态确认 (Link State Acknowledgment)分组。 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416112700434.png" alt="image-20210416112700434"></p>
<p>OSPF 使用可靠的洪泛法发送更新分组 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416112711490.png" alt="image-20210416112711490"></p>
<h3 id="指定的路由器"><a href="#指定的路由器" class="headerlink" title="指定的路由器"></a>指定的路由器</h3><p>若N个路由器连接在一个以太网上，则每个路由器要向其它N-1个路由器发送链路信息，因而总共需要N(N-1)个链路状态要传递</p>
<p>多点接入的局域网采用了指定的路由器 (designated router) 的方法，使广播的信息量大大减少。</p>
<p>指定的路由器代表该局域网上所有的链路向连接到该网络上的各路由器发送状态信息。 </p>
<h2 id="外部网关协议-BGP"><a href="#外部网关协议-BGP" class="headerlink" title="外部网关协议 BGP"></a>外部网关协议 BGP</h2><blockquote>
<p>简介：BGP 是<strong>不同自治系统的路由器之间交换路由信息的协议</strong>。 BGP 较新版本是 2006 年 1 月发表的 BGP-4（BGP 第 4 个版本），即 RFC 4271 ~ 4278。 可以将 BGP-4 简写为 BGP。</p>
</blockquote>
<p>互联网的规模太大，使得自治系统之间路由选择非常困难。对于自治系统之间的路由选择，要寻找最佳路由是很不现实的。当一条路径通过几个不同 AS 时，要想对这样的路径计算出有意义的代价是不太可能的。比较合理的做法是在 AS 之间交换“可达性”信息。自治系统之间的路由选择必须考虑有关策略。因此，边界网关协议 BGP 只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由。 </p>
<h3 id="BGP-发言人"><a href="#BGP-发言人" class="headerlink" title="BGP 发言人"></a>BGP 发言人</h3><p>每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“ BGP 发言人” (BGP speaker) 。</p>
<p>一般说来，两个 BGP 发言人都是通过一个共享网络连接在一起的，而 BGP 发言人往往就是 BGP 边界路由器，但也可以不是 BGP 边界路由器。 </p>
<h3 id="BGP-工作方式（交换路由信息）"><a href="#BGP-工作方式（交换路由信息）" class="headerlink" title="BGP 工作方式（交换路由信息）"></a>BGP 工作方式（交换路由信息）</h3><p>一个 BGP 发言人与其他自治系统中的 BGP 发言人要交换路由信息，就要<strong>先建立 TCP 连接</strong>，然后在此连接上<strong>交换 BGP 报文</strong>以<strong>建立 BGP 会话(session)</strong>，<strong>利用 BGP 会话交换路由信息</strong>。</p>
<p>使用 TCP 连接能提供<strong>可靠的服务</strong>，也简化了路由选择协议。使用 TCP 连接交换路由信息的两个 BGP 发言人，彼此成为对方的邻站(neighbor)或对等站(peer) 。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416151101050.png" alt="image-20210416151101050"></p>
<p>BGP 所交换的网络可达性的信息就是要到达某个网络所要经过的一系列 AS。当 BGP 发言人互相交换了网络可达性的信息后，各 BGP 发言人就根据所采用的策略从收到的路由信息中找出到达各 AS 的较好路由。 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416151211430.png" alt="image-20210416151211430"></p>
<p>自治系统 AS2 的 BGP 发言人通知主干网 AS1 的 BGP 发言人：“要到达网络 N1、 N2、N3 和 N4 可经过 AS2。” </p>
<p>主干网还可发出通知：“要到达网络 N5、N6 和 N7 可沿路径（AS1, AS3）。” </p>
<h3 id="特点-3"><a href="#特点-3" class="headerlink" title="特点"></a>特点</h3><p>BGP 协议交换路由信息的结点数量级是自治系统数的量级，这要比这些自治系统中的网络数少很多。</p>
<p>每一个自治系统中 BGP 发言人（或边界路由器）的数目是很少的。这样就使得自治系统之间的<strong>路由选择不致过分复杂</strong>。 </p>
<p><strong>BGP 支持 CIDR</strong>，因此 BGP 的路由表也就应当包括目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各个自治系统序列。</p>
<p>在 BGP 刚刚运行时，BGP 的邻站是交换整个的 BGP 路由表。但以后只需要在<strong>发生变化时更新有变化的部分</strong>。这样做对节省网络带宽和减少路由器的处理开销都有好处。 </p>
<h3 id="BGP-4报文"><a href="#BGP-4报文" class="headerlink" title="BGP-4报文"></a>BGP-4报文</h3><p>BGP-4 共使用四种报文</p>
<ol>
<li><strong>打开 (OPEN) 报文</strong>，用来与相邻的另一个BGP发言人建立关系。</li>
<li><strong>更新 (UPDATE) 报文</strong>，用来发送某一路由的信息，以及列出要撤消的多条路由。</li>
<li><strong>保活 (KEEPALIVE) 报文</strong>，用来确认打开报文和周期性地证实邻站关系。</li>
<li><strong>通知 (NOTIFICATION) 报文</strong>，用来发送检测到的差错。</li>
</ol>
<p>注意：撤销路由一次可以撤销许多条，而增加新路由时，每条更新报文只能增加一条</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416151624933.png" alt="image-20210416151624933"></p>
<h1 id="路由器的构成"><a href="#路由器的构成" class="headerlink" title="路由器的构成"></a>路由器的构成</h1><blockquote>
<p>路由器是一种典型的网络层设备。路由器是互联网中的关键设备。</p>
</blockquote>
<p><strong>路由器的主要作用是：</strong></p>
<ol>
<li><strong>连通不同的网络</strong>。</li>
<li><strong>选择信息传送的线路</strong>。选择通畅快捷的近路，能大大提高通信速度，减轻网络系统通信负荷，节约网络系统资源，提高网络系统畅通率，从而让网络系统发挥出更大的效益来。</li>
</ol>
<h2 id="路由器的结构以及工作方式"><a href="#路由器的结构以及工作方式" class="headerlink" title="路由器的结构以及工作方式"></a>路由器的结构以及工作方式</h2><p>路由器是一种具有多个输入端口和多个输出端口的专用计算机，其任务是<strong>转发分组</strong>。也就是说，<strong>将路由器某个输入端口收到的分组，按照分组要去的目的地（即目的网络），把该分组从路由器的某个合适的输出端口转发给下一跳路由器</strong>。</p>
<p>下一跳路由器也按照这种方法处理分组，直到该分组到达终点为止。 路由器的转发分组正是<strong>网络层</strong>的主要工作。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416152047881.png" alt="image-20210416152047881"></p>
<p>整个的路由器结构可划分为<strong>两大部分</strong>：</p>
<ol>
<li><strong>路由选择</strong>部分<ul>
<li>也叫做控制部分，其核心构件是路由选择处理机。</li>
<li>路由选择处理机的任务是根据所选定的路由选择协议构造出路由表，同时经常或定期地和相邻路由器交换路由信息而不断地更新和维护路由表。</li>
</ul>
</li>
<li>分组<strong>转发</strong>部分（由三部分组成）<ol>
<li>交换结构 (switching fabric)：又称为交换组织，其作用是<strong>根据转发表 (forwarding table) 对分组进行处理</strong>。</li>
<li>一组输入端口（硬件端口）</li>
<li>一组输出端口（硬件端口）</li>
</ol>
</li>
</ol>
<p><strong>“转发”(forwarding)</strong> 就是路由器根据转发表将用户的 IP 数据报从合适的端口转发出去。</p>
<p><strong>“路由选择”(routing)</strong> 则是按照分布式算法，根据从各相邻路由器得到的关于网络拓扑的变化情况，动态地改变所选择的路由。</p>
<p><strong>路由表是根据路由选择算法得出的。而转发表是从路由表得出的。</strong>在讨论路由选择的原理时，往往不去区分转发表和路由表的区别。</p>
<p>路由器的<strong>输入端口</strong>里面装有物理层、数据链路层和网络层的处理模块。数据链路层剥去帧首部和尾部后，将分组送到网络层的队列中排队等待处理。这会产生一定的时延。 <strong>输入端口中的查找和转发功能在路由器的交换功能中是最重要的。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416153037296.png" alt="image-20210416153037296"></p>
<p>输出端口将交换结构传送来的分组发送到线路 </p>
<p>输出端口里面同样装有物理层、数据链路层和网络层的处理模块。输出端口从交换结构接收分组，然后把它们发送到路由器外面的线路上。</p>
<p>在网络层的处理模块中设有一个<strong>缓冲区（队列）</strong>。当交换结构传送过来的分组的速率超过输出链路的发送速率时，来不及发送的分组就必须暂时存放在这个队列中。</p>
<p>数据链路层处理模块将分组加上链路层的首部和尾部，交给物理层后发送到外部线路。 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416153257591.png" alt="image-20210416153257591"></p>
<h2 id="分组丢弃"><a href="#分组丢弃" class="headerlink" title="分组丢弃"></a>分组丢弃</h2><p>若路由器处理分组的速率赶不上分组进入队列的速率，则队列的存储空间最终必定减少到零，这就使后面再进入队列的分组由于没有存储空间而只能被丢弃。<strong>路由器中的输入或输出队列产生溢出是造成分组丢失的重要原因。</strong></p>
<h2 id="交换结构"><a href="#交换结构" class="headerlink" title="交换结构"></a>交换结构</h2><p>交换结构是路由器的关键构件。正是这个交换结构把分组从一个输入端口转移到某个合适的输出端口。</p>
<p>实现交换有多种方法。常用交换方法有三种：<br>(1) 通过存储器<br>(2) 通过总线<br>(3) 通过纵横交换结构</p>
<h3 id="通过存储器"><a href="#通过存储器" class="headerlink" title="通过存储器"></a>通过存储器</h3><p>(1) 当路由器的某个输入端口收到一个分组时，就用中断方式通知路由选择处理机。然后分组就从输入端口复制到存储器中。</p>
<p>(2) 路由器处理机从分组首部提取目的地址，查找路由表，再将分组复制到合适的输出端口的缓存中。</p>
<p>(3) 若存储器的带宽（读或写）为每秒 M 个分组，那么路由器的交换速率（即分组从输入端口传送到输出端口的速率）一定小于 M/2。这是因为存储器对分组的读和写花费的时间是同一个数量级</p>
<h3 id="通过总线"><a href="#通过总线" class="headerlink" title="通过总线"></a>通过总线</h3><p>(1) 数据报从输入端口通过共享的总线直接传送到合适的输出端口，而不需要路由选择处理机的干预。</p>
<p>(2) 因为每一个要转发的分组都要通过这一条总线，因此路由器的转发带宽就受总线速率的限制。如果总线在忙，则被堵塞而没法通过交换结构，并在输入端口等待</p>
<p>(3) 现代的技术已经可以将总线的带宽提高到每秒吉比特的速率，因此<strong>许多的路由器产品都采用这种通过总线的交换方式</strong>。</p>
<h3 id="通过纵横交换结构-crossbar-switch-fabric"><a href="#通过纵横交换结构-crossbar-switch-fabric" class="headerlink" title="通过纵横交换结构 (crossbar switch fabric)"></a>通过纵横交换结构 (crossbar switch fabric)</h3><p>(1) 这种交换结构常称为互连网络 (interconnection network)。</p>
<p>(2) 它有 2N 条总线，可以使 N 个输入端口和 N 个输出端口相连接。</p>
<p>(3) 当输入端口收到一个分组时，就将它发送到与该输入端口相连的水平总线上。</p>
<p>(4) 若通向所要转发的输出端口的垂直总线是空闲的，则在这个结点将垂直总线与水平总线接通，然后将该分组转发到这个输出端口。</p>
<p>(5) 但若该垂直总线已被占用（有另一个分组正在转发到同一个输出端口），则后到达的分组就被阻塞，必须在输入端口排队。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416153548115.png" alt="image-20210416153548115"></p>
<h1 id="IPv6"><a href="#IPv6" class="headerlink" title="IPv6"></a>IPv6</h1><p>IP 是互联网的核心协议。互联网经过几十年的飞速发展，到 2011 年 2 月，IPv4 的 32 位地址已经耗尽。ISP 已经不能再申请到新的 IP 地址块了。我国在 2014 – 2015 年也逐步停止了向新用户和应用分配 IPv4 地址。解决 IP 地址耗尽的根本措施就是采用具有更大地址空间的新版本的 IP，即 IPv6。</p>
<p>IPv6 仍支持<strong>无连接的传送</strong>，但将协议数据单元 PDU 称为<strong>分组</strong>。为方便起见，计算机网络这本书仍采用<strong>数据报</strong>这一名词。所引进的主要变化如下：</p>
<ol>
<li><strong>更大的地址空间</strong>。IPv6 将地址从 IPv4 的 32 位 增大到了 128 位。 </li>
<li><strong>扩展的地址层次结构。</strong> </li>
<li><strong>灵活的首部格式。</strong> IPv6 定义了许多可选的扩展首部。</li>
<li><strong>改进的选项。</strong> IPv6 允许数据报包含有选项的控制信息，其选项放在有效载荷中。</li>
<li><strong>允许协议继续扩充。</strong> </li>
<li><strong>支持即插即用</strong>（即自动配置）。因此 IPv6 <strong>不需要使用 DHCP</strong>。</li>
<li><strong>支持资源的预分配</strong>。  IPv6 支持实时视像等要求，保证一定的带宽和时延的应用。</li>
<li><strong>IPv6 首部改为 8 字节对齐。</strong>首部长度必须是 8 字节的整数倍。原来的 IPv4 首部是 4 字节对齐。</li>
</ol>
<h2 id="IPv6-的基本首部"><a href="#IPv6-的基本首部" class="headerlink" title="IPv6 的基本首部"></a>IPv6 的基本首部</h2><p>IPv6 数据报由两大部分组成：</p>
<ol>
<li><strong>基本首部 (base header)</strong></li>
<li><strong>有效载荷 (payload)</strong>。有效载荷也称为净负荷。有效载荷允许有零个或多个扩展首部 (extension header)，再后面是数据部分。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416160353874.png" alt="image-20210416160353874"></p>
<p>IPv6 将首部长度变为固定的 40 字节，称为基本首部。把首部中不必要的功能取消了，使得 IPv6 首部的字段数减少到只有 8 个。IPv6 对首部中的某些字段进行了如下的更改：</p>
<ul>
<li>取消了首部长度字段，因为首部长度是固定的 40 字节；</li>
<li>取消了服务类型字段；</li>
<li>取消了总长度字段，改用有效载荷长度字段；</li>
<li>把 TTL 字段改称为跳数限制字段；</li>
<li>取消了协议字段，改用下一个首部字段；</li>
<li>取消了检验和字段；</li>
<li>取消了选项字段，而用扩展首部来实现选项功能。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416160803438.png" alt="image-20210416160803438"></p>
<p><strong>版本(version)</strong>—— 4 位。它指明了协议的版本，对 IPv6 该字段总是 6。 </p>
<p><strong>通信量类(traffic class)</strong>—— 8 位。这是为了区分不同的 IPv6 数据报的类别或优先级。目前正在进行不同的通信量类性能的实验。 </p>
<p><strong>流标号(flow label)</strong>—— 20 位。 “流”是互联网络上从特定源点到特定终点的一系列数据报， “流”所经过的路径上的路由器都保证指明的服务质量。所有属于同一个流的数据报都具有同样的流标号。 </p>
<p><strong>有效载荷长度(payload length)</strong>—— 16 位。它指明 IPv6 数据报除基本首部以外的字节数（所有扩展首部都算在有效载荷之内），其最大值是 64 KB。 </p>
<p><strong>下一个首部(next header)</strong>—— 8 位。它相当于 IPv4 的协议字段或可选字段。 </p>
<p><strong>跳数限制(hop limit)</strong>—— 8 位。源站在数据报发出时即设定跳数限制。路由器在转发数据报时将跳数限制字段中的值减 1。当跳数限制的值为零时，就要将此数据报丢弃。 </p>
<p><strong>源地址</strong>—— 128 位。是数据报的发送站的 IP 地址。 </p>
<p><strong>目的地址</strong>—— 128 位。是数据报的接收站的 IP 地址。 </p>
<p>IPv6 把原来 IPv4 首部中选项的功能都放在扩展首部中，并将扩展首部留给路径两端的源站和目的站的主机来处理。</p>
<p>数据报途中经过的路由器都不处理这些扩展首部（只有一个首部例外，即逐跳选项扩展首部）。这样就<strong>大大提高了路由器的处理效率</strong>。 </p>
<p>在 RFC 2460 中定义了六种扩展首部：</p>
<ol>
<li>逐跳选项</li>
<li>路由选择</li>
<li>分片</li>
<li>鉴别</li>
<li>封装安全有效载荷</li>
<li>目的站选项 </li>
</ol>
<h2 id="IPv6-的地址"><a href="#IPv6-的地址" class="headerlink" title="IPv6 的地址"></a>IPv6 的地址</h2><p>IPv6 数据报的目的地址可以是以下三种基本类型地址之一：</p>
<ol>
<li><strong>单播 (unicast)</strong>：传统的点对点通信。</li>
<li><strong>多播 (multicast)</strong>：一点对多点的通信。</li>
<li><strong>任播 (anycast)</strong>：这是 IPv6 增加的一种类型。任播的目的站是一组计算机，但数据报在交付时只交付其中的一个，通常是距离最近的一个。</li>
</ol>
<p>IPv6 将实现 IPv6 的主机和路由器均称为结点。一个结点就可能有多个与链路相连的接口。IPv6 地址是分配给结点上面的接口的。</p>
<ol>
<li>一个接口可以有多个单播地址。</li>
<li>其中的任何一个地址都可以当作到达该结点的目的地址。即一个结点接口的单播地址可用来唯一地标志该结点。</li>
</ol>
<p>为了使地址再稍简洁些，IPv6 使用冒号十六进制记法(colon hexadecimal notation, 简写为 colon hex)。每个 16 位的值用十六进制值表示，各值之间用冒号分隔。例如：68E6:8C64:FFFF:FFFF:0:1180:960A:FFFF，在十六进制记法中，允许把数字前面的 0 省略。例如把 0000 中的前三个 0 省略，写成 1 个 0。</p>
<p>冒号十六进制记法可以允许<strong>零压缩 (zero compression)</strong>，即一连串连续的零可以为一对冒号所取代。</p>
<p>FF05:0:0:0:0:0:0:B3    可压缩为：<br>FF05::B3<br><strong>注意：在任一地址中只能使用一次零压缩。</strong></p>
<p>冒号十六进制记法可结合使用点分十进制记法的后缀，这种结合在 IPv4 向 IPv6 的转换阶段特别有用。</p>
<p>例如：0:0:0:0:0:0:128.10.2.1 再使用零压缩即可得出：  ::128.10.2.1</p>
<p><strong>CIDR 的斜线表示法仍然可用。</strong><br>例如：60 位的前缀 12AB00000000CD3 可记为：<br>    12AB:0000:0000:CD30:0000:0000:0000:0000/60<br>或 12AB::CD30:0:0:0:0/60 （零压缩）<br>或 12AB:0:0:CD30::/60 （零压缩）</p>
<p>IPv6地址分类</p>
<table>
<thead>
<tr>
<th>地址类型</th>
<th>二进制前缀</th>
</tr>
</thead>
<tbody><tr>
<td>未指明地址</td>
<td>00…0（128位），可记为 ::/128。</td>
</tr>
<tr>
<td>环回地址</td>
<td>00…1（128位），可记为 ::1/128。</td>
</tr>
<tr>
<td>多播地址</td>
<td>11111111（8位），可记为 FF00::/8。</td>
</tr>
<tr>
<td>本地链路单播地址</td>
<td>1111111010（10位）,  可记为 FE80::/10。</td>
</tr>
<tr>
<td>全球单播地址</td>
<td>（除上述四种外，所有其他的二进制前缀）</td>
</tr>
</tbody></table>
<p><strong>未指明地址</strong>：这是 16 字节的全 0 地址，可缩写为两个冒号“::”。这个地址只能为还没有配置到一个标准的 IP 地址的主机当作源地址使用。这类地址仅此一个。</p>
<p><strong>环回地址：</strong>即 0:0:0:0:0:0:0:1（记为 ::1）。作用和 IPv4 的环回地址一样。这类地址也是仅此一个。</p>
<p><strong>多播地址：</strong>功能和 IPv4 的一样。这类地址占 IPv6 地址总数的 1/256。</p>
<p><strong>本地链路单播地址 (Link-Local Unicast Address)</strong> ：有些单位的网络使用 TCP/IP 协议，但并没有连接到互联网上。连接在这样的网络上的主机都可以使用这种本地地址进行通信，但不能和互联网上的其他主机通信。这类地址占 IPv6 地址总数的 1/1024。（也就是<strong>专用网</strong>，[虚拟专用网 VPN](#虚拟专用网 VPN)会聊到这部分）</p>
<p><strong>全球单播地址</strong><br>IPv6 的这一类单播地址是使用得最多的一类。<br>曾提出过多种方案来进一步划分这 128 位的单播地址。<br>根据 2006 年发布的草案标准 RFC 4291 的建议，  IPv6 单播地址的划分方法非常灵活。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416163300216.png" alt="image-20210416163300216"></p>
<h2 id="从-IPv4-向-IPv6-过渡"><a href="#从-IPv4-向-IPv6-过渡" class="headerlink" title="从 IPv4 向 IPv6 过渡"></a>从 IPv4 向 IPv6 过渡</h2><p>向 IPv6 过渡只能采用逐步演进的办法，同时，还必须使新安装的 IPv6 系统能够向后兼容：IPv6 系统必须能够接收和转发 IPv4 分组，并且能够为 IPv4 分组选择路由。两种向 IPv6 过渡的策略：</p>
<ol>
<li><strong>使用双协议栈</strong></li>
<li><strong>使用隧道技术</strong></li>
</ol>
<h3 id="双协议栈"><a href="#双协议栈" class="headerlink" title="双协议栈"></a>双协议栈</h3><p>双协议栈 (dual stack) 是指在完全过渡到 IPv6 之前，使一部分主机（或路由器）装有两个协议栈，一个 IPv4 和一个 IPv6。</p>
<p>双协议栈的主机（或路由器）记为 IPv6/IPv4，表明它同时具有两种 IP 地址：一个 IPv6 地址和一个 IPv4 地址。</p>
<p>双协议栈主机在和 IPv6 主机通信时是采用 IPv6 地址，而和 IPv4 主机通信时就采用 IPv4 地址。</p>
<p>根据 DNS 返回的地址类型可以确定使用 IPv4 地址还是 IPv6 地址。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416163413506.png" alt="image-20210416163413506"></p>
<h3 id="隧道技术"><a href="#隧道技术" class="headerlink" title="隧道技术"></a>隧道技术</h3><p>在 IPv6 数据报要进入 IPv4 网络时，把 IPv6 数据报封装成为 IPv4 数据报，整个的 IPv6 数据报变成了 IPv4 数据报的数据部分。当 IPv4 数据报离开 IPv4 网络中的隧道时，再把数据部分（即原来的 IPv6 数据报）交给主机的 IPv6 协议栈。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416163442462.png" alt="image-20210416163442462"></p>
<h2 id="ICMPv6"><a href="#ICMPv6" class="headerlink" title="ICMPv6"></a>ICMPv6</h2><p>IPv6 也不保证数据报的可靠交付，因为互联网中的路由器可能会丢弃数据报。</p>
<p>因此 IPv6 也需要使用 <strong>ICMP</strong> 来反馈一些差错信息。新的版本称为 ICMPv6。</p>
<p><strong>地址解析协议 ARP 和网际组管理协议 IGMP 协议的功能都已被合并到 ICMPv6 中。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416163550279.png" alt="image-20210416163550279"></p>
<p>CMPv6 是面向报文的协议，它利用报文来报告差错，获取信息，探测邻站或管理多播通信。</p>
<p>ICMPv6 还增加了几个定义报文的功能及含义的其他协议。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416163605022.png" alt="image-20210416163605022"></p>
<h1 id="IP-多播"><a href="#IP-多播" class="headerlink" title="IP 多播"></a>IP 多播</h1><h2 id="IP-多播的基本概念"><a href="#IP-多播的基本概念" class="headerlink" title="IP 多播的基本概念"></a>IP 多播的基本概念</h2><p>IP 多播 (multicast，以前曾译为组播) 已成为互联网的一个热门课题。</p>
<blockquote>
<p>在互联网上进行多播就叫做 IP 多播。<br>互联网范围的多播要靠路由器来实现。<br>能够运行多播协议的路由器称为<strong>多播路由器(multicast router)</strong>。当然它<strong>也可以转发普通的单播IP数据报</strong>。</p>
</blockquote>
<p><strong>目的：更好地支持一对多通信。</strong></p>
<p><strong>一对多通信：一个源点发送到许多个终点</strong>。</p>
<p>例如，实时信息的交付（如新闻、股市行情等），<strong>软件更新</strong>，<strong>交互式会议</strong>及其他多媒体通信。</p>
<p>采用单播方式，向 90 台主机传送，同样的视频节目需要发送 90 个单播，如下图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416163820605.png" alt="image-20210416163820605"></p>
<p>采用多播方式，只需发送一次到多播组。<strong>路由器复制分组</strong>。<strong>局域网具有硬件多播功能</strong>，不需要复制分组。</p>
<p>这样的好处是：当多播组的主机数很大时（如成千上万个），采用多播方式就可明显地减轻网络中各种资源的消耗。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416163835811.png" alt="image-20210416163835811"></p>
<h3 id="多播-IP-地址"><a href="#多播-IP-地址" class="headerlink" title="多播 IP 地址"></a>多播 IP 地址</h3><ul>
<li>IP 多播所传送的分组需要使用多播 IP 地址。</li>
<li>在多播数据报的目的地址写入的是<strong>多播组的标识符</strong>。</li>
<li>多播组的标识符就是 <strong>IP 地址中的 D 类地址</strong>（多播地址，前面有提到过——[ip地址的分类](#分类的 IP 地址)）。</li>
<li><strong>每一个 D 类地址标志一个多播组</strong>。</li>
<li><strong>多播地址只能用于目的地址</strong>，不能用于源地址。</li>
</ul>
<h3 id="多播数据报"><a href="#多播数据报" class="headerlink" title="多播数据报"></a>多播数据报</h3><p>多播数据报和一般的 IP 数据报的区别就是它使用 D 类 IP 地址作为目的地址，并且首部中的<strong>协议字段值是 2，表明使用网际组管理协议 IGMP</strong>。</p>
<p>多播数据报也是<strong>“尽最大努力交付”</strong>，不保证一定能够交付多播组内的所有成员。</p>
<p>对<strong>多播数据报不产生 ICMP 差错报文</strong>。因此，若在 PING 命令后面键入多播地址，将永远不会收到响应。</p>
<h2 id="在局域网上进行硬件多播"><a href="#在局域网上进行硬件多播" class="headerlink" title="在局域网上进行硬件多播"></a>在局域网上进行硬件多播</h2><p>互联网号码指派管理局 IANA 拥有的以太网地址块的高 24 位为 00-00-5E。因此 TCP/IP 协议使用的以太网地址块的范围是<strong>从   00-00-5E-00-00-00 到   00-00-5E-7F-FF-FF</strong> ，不难看出（挺难看出的），在每一个地址中，只有23位可用作多播。D 类 IP 地址可供分配的有 28 位，在这 28 位中的前 5 位不能用来构成以太网硬件地址。 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416164552924.png" alt="image-20210416164552924"></p>
<p>由于多播 IP 地址与以太网硬件地址的映射关系不是唯一的，因此收到多播数据报的主机，<strong>还要在 IP 层利用软件进行过滤，</strong>把不是本主机要接收的数据报丢弃。</p>
<h2 id="网际组管理协议-IGMP-和多播路由选择协议"><a href="#网际组管理协议-IGMP-和多播路由选择协议" class="headerlink" title="网际组管理协议 IGMP 和多播路由选择协议"></a>网际组管理协议 IGMP 和多播路由选择协议</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>为了使路由器知道多播组成员的信息，需要利用<strong>网际组管理协议 IGMP (Internet Group Management Protocol)</strong>。</p>
<p>连接在局域网上的多播路由器还必须和互联网上的其他多播路由器协同工作，以便把多播数据报用最小代价传送给所有的组成员。这就需要使用<strong>多播路由选择协议</strong>。 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416165016871.png" alt="image-20210416165016871"></p>
<p>IGMP 并非在互联网范围内对所有多播组成员进行管理的协议。IGMP 不知道 IP 多播组包含的成员数，也不知道这些成员都分布在哪些网络上<strong>。IGMP 协议是让连接在本地局域网上的多播路由器知道本局域网上是否有主机（严格讲，是主机上的某个进程）参加或退出了某个多播组。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416165127191.png" alt="image-20210416165127191"></p>
<p>多播转发必须动态地适应多播组成员的变化（这时网络拓扑并未发生变化）。请注意，单播路由选择通常是在网络拓扑发生变化时才需要更新路由。</p>
<p>多播路由器在转发多播数据报时，不能仅仅根据多播数据报中的目的地址，而是还要考虑这个<strong>多播数据报从什么地方来和要到什么地方去。</strong> </p>
<p>多播数据报<strong>可以由没有加入多播组的主机发出，也可以通过没有组成员接入的网络。</strong> </p>
<h3 id="网际组管理协议-IGMP"><a href="#网际组管理协议-IGMP" class="headerlink" title="网际组管理协议 IGMP"></a>网际组管理协议 IGMP</h3><p>和 ICMP 相似，<strong>IGMP 使用 IP 数据报传递其报文</strong>（即 IGMP 报文加上 IP 首部构成 IP 数据报），但它也向 IP 提供服务。因此，我们不把 IGMP 看成是一个单独的协议，而是属于整个网际协议 IP 的一个组成部分。 </p>
<h4 id="第一阶段：加入多播组"><a href="#第一阶段：加入多播组" class="headerlink" title="第一阶段：加入多播组"></a>第一阶段：加入多播组</h4><p>当某个主机加入新的多播组时，该主机应向多播组的多播地址发送 IGMP 报文，声明自己要成为该组的成员。本地的多播路由器收到 IGMP 报文后，将组成员关系转发给互联网上的其他多播路由器。</p>
<h4 id="第二阶段：探询组成员变化情况"><a href="#第二阶段：探询组成员变化情况" class="headerlink" title="第二阶段：探询组成员变化情况"></a>第二阶段：探询组成员变化情况</h4><p>因为组成员关系是动态的，因此本地多播路由器要周期性地探询本地局域网上的主机，以便知道这些主机是否还继续是组的成员。</p>
<p>只要对某个组有一个主机响应，那么多播路由器就认为这个组是活跃的。但一个组在经过几次的探询后仍然没有一个主机响应，则不再将该组的成员关系转发给其他的多播路由器。</p>
<p><strong>在主机和多播路由器之间的所有通信都是使用 IP 多播。</strong></p>
<p>多播路由器在探询组成员关系时，只需要对所有的组发送一个请求信息的询问报文，而不需要对每一个组发送一个询问报文。默认的询问速率是每 125 秒发送一次。</p>
<p>当同一个网络上连接有几个多播路由器时，它们能够迅速和有效地选择其中的一个来探询主机的成员关系。 </p>
<p>在 IGMP 的询问报文中有一个数值 N，它指明一个最长响应时间（默认值为 10 秒）。当收到询问时，主机在 0 到 N 之间随机选择发送响应所需经过的时延。对应于最小时延的响应最先发送。</p>
<p>同一个组内的每一个主机都要监听响应，只要有本组的其他主机先发送了响应，自己就可以不再发送响应了。 </p>
<h3 id="多播路由选择"><a href="#多播路由选择" class="headerlink" title="多播路由选择"></a>多播路由选择</h3><p>多播路由选择协议尚未标准化。一个多播组中的成员是动态变化的，随时会有主机加入或离开这个多播组。</p>
<p><strong>多播路由选择实际上就是要找出以源主机为根结点的多播转发树。</strong></p>
<p>在多播转发树上的路由器不会收到重复的多播数据报。对不同的多播组对应于不同的多播转发树。同一个多播组，对不同的源点也会有不同的多播转发树。</p>
<p>多播路由选择协议在转发多播数据报时使用三种方法：</p>
<ol>
<li>洪泛与剪除</li>
<li>隧道技术 (tunneling)</li>
<li>基于核心的发现技术 </li>
</ol>
<h4 id="洪泛与剪除"><a href="#洪泛与剪除" class="headerlink" title="洪泛与剪除"></a>洪泛与剪除</h4><p>这种方法适合于较小的多播组，而所有的组成员接入的局域网也是相邻接的。</p>
<p>一开始，路由器转发多播数据报使用洪泛的方法（这就是<strong>广播</strong>）。<br>为了避免兜圈子，采用了叫做<strong>反向路径广播 RPB</strong> (Reverse Path Broadcasting) 的策略。 </p>
<p>什么是RPB</p>
<blockquote>
<p>路由器收到多播数据报时，先检查它是否是从源点经最短路径传送来的。若是，就向所有其他方向转发刚才收到的多播数据报（但进入的方向除外），否则就丢弃而不转发。</p>
<p>如果存在几条同样长度的最短路径，那么只能选择一条最短路径，选择的准则就是看这几条最短路径中的相邻路由器谁的 IP 地址最小。 </p>
<p>最后就得出了用来转发多播数据报的多播转发树，以后就按这个多播转发树转发多播数据报。避免了多播数据报的兜圈子，同时每一个路由器也不会接收重复的多播数据报。</p>
</blockquote>
<p>要点</p>
<ul>
<li>如果在多播转发树上的某个路由器发现它的下游树枝（即叶节点方向）已没有该多播组的成员，就应把它和下游的树枝一起剪除。</li>
<li>当某个树枝有新增加的组成员时，可以再接入到多播转发树上。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416171012381.png" alt="image-20210416171012381"></p>
<h4 id="隧道技术-tunneling"><a href="#隧道技术-tunneling" class="headerlink" title="隧道技术 (tunneling)"></a>隧道技术 (tunneling)</h4><p>隧道技术适用于<strong>多播组的位置在地理上很分散</strong>的情况。</p>
<p>简单地说就是讲多播数据报进行封装成单播数据包，然后在不支持多播的网络上传递，如下图所示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416171052103.png" alt="image-20210416171052103"></p>
<h4 id="基于核心的发现技术"><a href="#基于核心的发现技术" class="headerlink" title="基于核心的发现技术"></a>基于核心的发现技术</h4><p>这种方法对于多播组的大小在较大范围内变化时都适合。这种方法是<strong>对每一个多播组 G 指定一个核心(core) 路由器，给出它的 IP 单播地址。</strong>核心路由器按照前面讲过的方法创建出对应于多播组 G 的转发树。</p>
<p>没了，就这样 </p>
<h1 id="虚拟专用网-VPN-和网络地址转换-NAT"><a href="#虚拟专用网-VPN-和网络地址转换-NAT" class="headerlink" title="虚拟专用网 VPN 和网络地址转换 NAT"></a>虚拟专用网 VPN 和网络地址转换 NAT</h1><h2 id="虚拟专用网-VPN"><a href="#虚拟专用网-VPN" class="headerlink" title="虚拟专用网 VPN"></a>虚拟专用网 VPN</h2><p>由于 IP 地址的紧缺，一个机构能够申请到的IP地址数往往远小于本机构所拥有的主机数。考虑到互联网并不很安全，一个机构内也并不需要把所有的主机接入到外部的互联网。假定在一个机构内部的计算机通信也是采用 TCP/IP 协议，那么从原则上讲，对于这些仅在机构内部使用的计算机就可以由本机构自行分配其 IP 地址。</p>
<p>所以地址被分成了两种——本地地址与全球地址</p>
<p><strong>本地地址</strong>——仅在机构内部使用的 IP 地址，可以由本机构自行分配，而不需要向互联网的管理机构申请。</p>
<p><strong>全球地址</strong>——全球唯一的 IP 地址，必须向互联网的管理机构申请。 </p>
<p>但是在内部使用的本地地址就有可能和互联网中某个 IP 地址重合，这样就会出现地址的二义性问题。</p>
<p>解决方法：RFC 1918 指明了一些专用地址 (private address)。专用地址只能用作本地地址而不能用作全球地址。在互联网中的所有路由器，对目的地址是专用地址的数据报一律不进行转发</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416172336933.png" alt="image-20210416172336933"></p>
<p>采用这样的专用 IP 地址的互连网络称为<strong>专用互联网</strong>或<strong>本地互联网</strong>，或更简单些，就叫做<strong>专用网</strong>。<br>因为这些专用地址仅在本机构内部使用。<strong>专用IP地址也叫做可重用地址 (reusable address)</strong>。</p>
<blockquote>
<p>利用公用的互联网作为本机构各专用网之间的通信载体，这样的专用网又称为虚拟专用网VPN (Virtual Private Network)。</p>
</blockquote>
<p>“专用网”是因为这种网络是为本机构的主机用于机构内部的通信，而不是用于和网络外非本机构的主机通信。“虚拟”表示“好像是”，但实际上并不是，因为现在并没有真正使用通信专线，而VPN只是在效果上和真正的专用网一样。</p>
<p>如果专用网不同网点之间的通信必须经过公用的互联网，但又有保密的要求，那么所有通过互联网传送的数据都必须加密。一个机构要构建自己的 VPN 就必须为它的每一个场所购买专门的硬件和软件，并进行配置，使每一个场所的 VPN 系统都知道其他场所的地址。</p>
<p>用隧道技术实现虚拟专用网（如下图）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416172632581.png" alt="image-20210416172632581"></p>
<p>具体看看隧道技术如何实现</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416172718117.png" alt="image-20210416172718117"><br>由部门 A 和 B 的内部网络所构成的虚拟专用网 VPN 又称为内联网 (intranet)，表示部门 A 和 B 都是在同一个机构的内部。一个机构和某些外部机构共同建立的虚拟专用网 VPN 又称为外联网 (extranet)。 它们都是基于 TCP/IP 协议的。</p>
<h3 id="远程接入-VPN"><a href="#远程接入-VPN" class="headerlink" title="远程接入 VPN"></a>远程接入 VPN</h3><p>远程接入 VPN (remote access VPN)可以满足外部流动员工访问公司网络的需求。</p>
<p>在外地工作的员工拨号接入互联网，而驻留在员工 PC 机中的 VPN 软件可在员工的 PC 机和公司的主机之间建立 VPN 隧道，因而外地员工与公司通信的内容是保密的，员工们感到好像就是使用公司内部的本地网络。 </p>
<h2 id="网络地址转换-NAT"><a href="#网络地址转换-NAT" class="headerlink" title="网络地址转换 NAT"></a>网络地址转换 NAT</h2><p>如何在专用网上使用专用地址的主机与互联网上的主机通信</p>
<p>想象一下，咱们用的校园网，如果细心点的话你会发现它就是一个本地互联网，而如果你连上了校园网wifi，不通过登录你是可以访问得到校园网里面的某些网址的，也就是内部互相访问，但是一旦你需要上个百度啥的，你就需要登录自己的校园网账号，那这是怎么做到滴呢，这个问题就和上面那个问题一致</p>
<p>有两种方法</p>
<ol>
<li>再申请一些全球 IP 地址。但这在很多情况下是不容易做到的。</li>
<li>采用网络地址转换 NAT。这是目前使用得最多的方法。</li>
</ol>
<h3 id="NAT使用前提"><a href="#NAT使用前提" class="headerlink" title="NAT使用前提"></a>NAT使用前提</h3><p>需要在专用网连接到互联网的路由器上安装 NAT 软件。装有 NAT 软件的路由器叫做 NAT路由器，它至少有一个有效的外部全球IP地址。<br>所有使用本地地址的主机在和外界通信时，都要在 NAT 路由器上将其本地地址转换成全球 IP 地址，才能和互联网连接。 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416173906968.png" alt="image-20210416173906968"></p>
<ol>
<li>内部主机 A 用本地地址 IPA 和互联网上主机 B 通信所发送的数据报必须经过 NAT 路由器。</li>
<li>NAT 路由器将数据报的<strong>源地址 IPA 转换成全球地址 IPG</strong> ，并把转换结果记录到NAT地址转换表中，目的地址 IPB 保持不变，然后发送到互联网。</li>
<li>NAT 路由器收到主机 B 发回的数据报时，知道数据报中的源地址是  IPB  而目的地址是 <strong>IPG</strong>  。</li>
<li>根据 NAT 转换表，NAT 路由器将目的地址 IPG 转换为 IPA ，转发给最终的内部主机 A。 </li>
</ol>
<p>可以看出，在内部主机与外部主机通信时，在NAT路由器上发生了两次地址转换：离开专用网时：替换源地址，将内部地址替换为全球地址；进入专用网时：替换目的地址，将全球地址替换为内部地址；</p>
<table>
<thead>
<tr>
<th>方向</th>
<th>字段</th>
<th>旧的IP地址</th>
<th>新的IP地址</th>
</tr>
</thead>
<tbody><tr>
<td>出</td>
<td>源IP地址</td>
<td>192.168.0.3</td>
<td>172.38.1.5</td>
</tr>
<tr>
<td>入</td>
<td>目的IP地址</td>
<td>172.38.1.5</td>
<td>192.168.0.3</td>
</tr>
<tr>
<td>出</td>
<td>源IP地址</td>
<td>192.168.0.7</td>
<td>172.38.1.6</td>
</tr>
<tr>
<td>入</td>
<td>目的IP地址</td>
<td>172.38.1.6</td>
<td>192.168.0.7</td>
</tr>
</tbody></table>
<p>当 NAT 路由器具有 <strong>n 个全球 IP 地址时</strong>，专用网内<strong>最多可以同时有 n 台主机接入到互联网</strong>。这样就可以使专用网内较多数量的主机，轮流使用 NAT 路由器有限数量的全球 IP 地址。</p>
<p><strong>通过 NAT 路由器的通信必须由专用网内的主机发起。专用网内部的主机不能充当服务器用，因为互联网上的客户无法请求专用网内的服务器提供服务。</strong></p>
<h3 id="网络地址与端口号转换-NAPT"><a href="#网络地址与端口号转换-NAPT" class="headerlink" title="网络地址与端口号转换 NAPT"></a>网络地址与端口号转换 NAPT</h3><p>为了更加有效地利用 NAT 路由器上的全球IP地址，现在常用的 NAT 转换表把运输层的端口号也利用上。这样，就可以使多个拥有本地地址的主机，<strong>共用一个 NAT 路由器上的全球 IP 地址</strong>，因而可以同时和互联网上的不同主机进行通信。</p>
<p><strong>使用端口号的 NAT 叫做网络地址与端口号转换NAPT (Network Address and Port Translation)</strong>，而不使用端口号的 NAT 就叫做传统的 NAT (traditional NAT)。</p>
<p>举个栗子，如下表所示，讲专用网内的ip地址进行转换</p>
<table>
<thead>
<tr>
<th>方向</th>
<th>字段</th>
<th>旧的IP地址和端口号</th>
<th>新的IP地址和端口号</th>
</tr>
</thead>
<tbody><tr>
<td>出</td>
<td>源IP地址:TCP源端口</td>
<td>192.168.0.3:30000</td>
<td>172.38.1.5:40001</td>
</tr>
<tr>
<td>出</td>
<td>源IP地址:TCP源端口</td>
<td>192.168.0.4:30000</td>
<td>172.38.1.5:40002</td>
</tr>
<tr>
<td>入</td>
<td>目的IP地址:TCP目的端口</td>
<td>172.38.1.5:40001</td>
<td>192.168.0.3:30000</td>
</tr>
<tr>
<td>入</td>
<td>目的IP地址:TCP目的端口</td>
<td>172.38.1.5:40002</td>
<td>192.168.0.4:30000</td>
</tr>
</tbody></table>
<p>NAPT把专用网内不同的源 IP 地址，都转换为同样的全球 IP 地址。但对源主机所采用的 TCP 端口号（不管相同或不同），则转换为不同的新的端口号。因此，当 NAPT 路由器收到从互联网发来的应答时，就可以从 IP 数据报的数据部分找出运输层的端口号，然后根据不同的目的端口号，从 NAPT 转换表中找到正确的目的主机。</p>
<h1 id="多协议标记交换-MPLS"><a href="#多协议标记交换-MPLS" class="headerlink" title="多协议标记交换 MPLS"></a>多协议标记交换 MPLS</h1><p><strong>“多协议”</strong>表示在 MPLS 的上层可以采用多种协议，例如：IP，IPX；可以使用多种数据链路层协议，例如：PPP，以太网，ATM 等。<strong>“标记”</strong>是指每个分组被打上一个标记，根据该标记对分组进行转发。</p>
<p>为了实现交换，可以利用面向连接的概念，使每个分组携带一个叫做标记 (label) 的小整数。当分组到达交换机（即标记交换路由器）时，交换机读取分组的标记，并用标记值来检索分组转发表。 这样就比查找路由表来转发分组要快得多（下面会详细讲述其差别）。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416181924069.png" alt="image-20210416181924069"></p>
<p><strong>MPLS 的特点</strong></p>
<p>MPLS 并没有取代 IP，而是作为一种 IP 增强技术，被广泛地应用在互联网中。</p>
<p>MPLS 具有以下三个方面的特点：</p>
<ol>
<li>支持面向连接的服务质量；</li>
<li>支持流量工程，平衡网络负载；</li>
<li>有效地支持虚拟专用网 VPN。</li>
</ol>
<h2 id="MPLS-的工作原理"><a href="#MPLS-的工作原理" class="headerlink" title="MPLS 的工作原理"></a>MPLS 的工作原理</h2><h3 id="基本工作过程"><a href="#基本工作过程" class="headerlink" title="基本工作过程"></a>基本工作过程</h3><p>首先来看看传统的IP 分组的转发</p>
<p>(1) 在传统的 IP 网络中，分组每到达一个路由器后，都必须提取出其目的地址，按目的地址查找路由表，并按照“最长前缀匹配”的原则找到下一跳的 IP 地址（请注意，前缀的长度是不确定的）。</p>
<p>(2) 当网络很大时，查找含有大量项目的路由表要花费很多的时间。</p>
<p>(3) 在出现突发性的通信量时，往往还会使缓存溢出，这就会引起分组丢失、传输时延增大和服务质量下降。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416182509873.png" alt="image-20210416182509873"></p>
<p>而MPLS 协议的基本原理如下</p>
<p>在 <strong>MPLS 域的入口处</strong>，<strong>给每一个 IP 数据报打上固定长度“标记”</strong>，然后对打上标记的 IP 数据报用<strong>硬件</strong>进行<strong>转发</strong>。</p>
<p>采用硬件技术对打上标记的 IP 数据报进行转发就称为<strong>标记交换</strong>。</p>
<p>“交换”也表示在转发时<strong>不再上升到第三层查找转发表，而是根据标记在第二层（链路层）用硬件进行转发</strong>。</p>
<p><strong>MPLS 域 (MPLS domain)</strong> 是指该域中有许多彼此相邻的路由器，并且所有的路由器都是支持 MPLS 技术的标记交换路由器 LSR (Label Switching Router)。</p>
<p>LSR 同时具有标记交换和路由选择这两种功能，标记交换功能是为了快速转发，<strong>但在这之前LSR 需要使用路由选择功能构造转发表</strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416182738831.png" alt="image-20210416182738831"></p>
<h2 id="MPLS-的基本工作过程"><a href="#MPLS-的基本工作过程" class="headerlink" title="MPLS 的基本工作过程"></a>MPLS 的基本工作过程</h2><p>(1)  MPLS 域中的各 LSR 使用专门的<strong>标记分配协议 LDP</strong> 交换报文，并找出<strong>标记交换路径 LSP</strong>。各 LSR 根据这些路径<strong>构造出分组转发表</strong>。 </p>
<p>(2)  分组进入到 MPLS 域时， MPLS <strong>入口结点把分组打上标记</strong>，并按照转发表将分组转发给下一个 LSR。给 IP 数据报打标记的过程叫做<strong>分类 (classification)</strong>。</p>
<p>(3) 一个标记仅仅在两个标记交换路由器 LSR 之间才有意义。分组每经过一个 LSR，<strong>LSR 就要做两件事</strong>：<strong>一是转发</strong>，<strong>二是更换新的标记</strong>，即把入标记更换成为出标记。这就叫做标记对换 (label swapping)。</p>
<p>下面是转发表的一个举例</p>
<table>
<thead>
<tr>
<th>入接口</th>
<th>入标记</th>
<th>出接口</th>
<th>出标记</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>3</td>
<td>1</td>
<td>1</td>
</tr>
</tbody></table>
<p>该表的含义是含义：从入接口 0 收到一个入标记为 3 的IP 数据报，转发时，应当把该IP数据报从出接口 1 转发出去，同时把标记对换为 1。</p>
<p>(4) 当分组离开 MPLS 域时，MPLS 出口结点把分组的标记去除。再以后就按照一般分组的转发方法进行转发。</p>
<blockquote>
<p>上述的这种“由入口 LSR 确定进入 MPLS 域以后的转发路径”称为<strong>显式路由选择 (explicit routing)</strong>，它和互联网中通常使用的“<strong>每一个路由器逐跳进行路由选择</strong>”有着很大的区别。</p>
</blockquote>
<h2 id="转发等价类-FEC"><a href="#转发等价类-FEC" class="headerlink" title="转发等价类 FEC"></a>转发等价类 FEC</h2><p>MPLS 有个很重要的概念就是<strong>转发等价类 FEC</strong> (Forwarding Equivalence Class)。“转发等价类”就是<strong>路由器按照同样方式对待的分组的集合</strong>。 </p>
<blockquote>
<p>“按照同样方式对待”表示：从同样接口转发到同样的下一跳地址，并且具有同样服务类别和同样丢弃优先级等。</p>
</blockquote>
<p>划分 FEC 的方法不受什么限制，这都由网络管理员来控制，因此非常灵活。</p>
<p>入口结点并不是给每一个分组指派一个不同的标记，而是将属于同样 FEC 的分组都指派同样的标记。</p>
<p>FEC 和标记是一一对应的关系。</p>
<p>这样，就可以把它用于<strong>负载平衡</strong>啦，如下图流量工程</p>
<h3 id="流量工程"><a href="#流量工程" class="headerlink" title="流量工程"></a>流量工程</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416183529710.png" alt="流量工程"></p>
<p>(1) 网络管理员采用自定义的 FEC 就可以更好地管理网络的资源。</p>
<p>(2) 这种均衡网络负载的做法也称为<strong>流量工程 TE</strong> (Traffic Engineering) 或<strong>通信量工</strong>程。</p>
<h2 id="MPLS-首部的位置与格式"><a href="#MPLS-首部的位置与格式" class="headerlink" title="MPLS 首部的位置与格式"></a>MPLS 首部的位置与格式</h2><p>MPLS 并不要求下层的网络都使用面向连接的技术。下层的网络并不提供打标记的手段，而 IPv4 数据报首部也没有多余的位置存放 MPLS 标记。这就需要使用一种封装技术：<strong>在把 IP 数据报封装成以太网帧之前，先要插入一个 MPLS 首部</strong>。</p>
<p><strong>从层次的角度看，MPLS 首部就处在第二层和第三层之间。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416183818917.png" alt="image-20210416183818917"></p>
<p><strong>“给 IP 数据报打上标记”</strong>其实就是在以太网的帧首部和  IP 数据报的首部之间插入一个 4 字节的 MPLS 首部。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/image-20210416183828881.png" alt="image-20210416183828881"></p>
<p><strong>MPLS 首部共包括以下四个字段：</strong></p>
<p>(1) 标记值（占 20 位）。可以同时容纳高达 220 个流（即 1048576 个流）。实际上几乎没有哪个 MPLS 实例会使用很大数目的流，因为通常需要管理员人工管理和设置每条交换路径。</p>
<p>(2) 试验（占 3 位）。目前保留用作试验。</p>
<p>(3) 栈S（占 1 位）。在有“标记栈”时使用。</p>
<p>(4) 生存时间TTL（占 8 位）。用来防止 MPLS 分组在 MPLS 域中兜圈子。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://Dong-666.github.io">天际线上的猪</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://dong-666.github.io/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/">http://dong-666.github.io/2021/04/18/%E7%BD%91%E7%BB%9C%E5%B1%82/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://Dong-666.github.io" target="_blank">Dong</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a></div><div class="post_share"><div class="social-share" data-image="/img/code.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.png" target="_blank"><img class="post-qr-code-img" src="/img/wechat.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/04/18/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%A6%82%E8%BF%B0/" title="计算机网络概述"><img class="cover" src="/img/code.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">计算机网络概述</div></div></a></div><div class="next-post pull-right"><a href="/2021/04/18/%E8%BF%90%E8%BE%93%E5%B1%82/" title="计算机网络-运输层"><img class="cover" src="/img/code.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">计算机网络-运输层</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/07/28/http%E5%8D%8F%E8%AE%AE/" title="http协议"><img class="cover" src="/img/code.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-28</div><div class="title">http协议</div></div></a></div><div><a href="/2021/04/18/%E5%BA%94%E7%94%A8%E5%B1%82/" title="计算机网络-应用层"><img class="cover" src="/img/code.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-18</div><div class="title">计算机网络-应用层</div></div></a></div><div><a href="/2021/03/05/%E7%89%A9%E7%90%86%E5%B1%82/" title="计算机网络-物理层"><img class="cover" src="/img/code.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-05</div><div class="title">计算机网络-物理层</div></div></a></div><div><a href="/2021/04/18/%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82/" title="计算机网络-数据链路层"><img class="cover" src="/img/code.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-18</div><div class="title">计算机网络-数据链路层</div></div></a></div><div><a href="/2021/04/18/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%A6%82%E8%BF%B0/" title="计算机网络概述"><img class="cover" src="/img/code.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-18</div><div class="title">计算机网络概述</div></div></a></div><div><a href="/2021/04/18/%E8%BF%90%E8%BE%93%E5%B1%82/" title="计算机网络-运输层"><img class="cover" src="/img/code.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-18</div><div class="title">计算机网络-运输层</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">天际线上的猪</div><div class="author-info__description">记录生活，记录学习</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">106</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">35</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">14</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Dong-666"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="tencent://message/?uin=2834471179&amp;Site=&amp;Menu=yes" target="_blank" title="QQ"><i class="fab fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">哇，你居然发现了这个宝藏博客！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%B1%82%E6%8F%90%E4%BE%9B%E4%BD%95%E7%A7%8D%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">网络层提供何种服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A9%E7%BD%91%E7%BB%9C%E8%B4%9F%E8%B4%A3%E5%8F%AF%E9%9D%A0%E4%BA%A4%E4%BB%98"><span class="toc-number">1.1.</span> <span class="toc-text">让网络负责可靠交付</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%8F%90%E4%BE%9B%E6%95%B0%E6%8D%AE%E6%8A%A5%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.2.</span> <span class="toc-text">网络提供数据报服务</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E9%99%85%E5%8D%8F%E8%AE%AE-IP"><span class="toc-number">2.</span> <span class="toc-text">网际协议 IP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E4%BA%92%E8%BF%9E%E7%BD%91%E7%BB%9C"><span class="toc-number">2.1.</span> <span class="toc-text">虚拟互连网络</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E4%BA%92%E8%BF%9E%E7%BD%91%E7%BB%9C%E7%9A%84%E6%84%8F%E4%B9%89"><span class="toc-number">2.1.1.</span> <span class="toc-text">虚拟互连网络的意义</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E7%B1%BB%E7%9A%84-IP-%E5%9C%B0%E5%9D%80"><span class="toc-number">2.2.</span> <span class="toc-text">分类的 IP 地址</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IP-%E5%9C%B0%E5%9D%80%E5%8F%8A%E5%85%B6%E8%A1%A8%E7%A4%BA%E6%96%B9%E6%B3%95"><span class="toc-number">2.2.1.</span> <span class="toc-text">IP 地址及其表示方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%82%B9%E5%88%86%E5%8D%81%E8%BF%9B%E5%88%B6%E8%AE%B0%E6%B3%95"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">点分十进制记法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%88%AB%E7%9A%84-IP-%E5%9C%B0%E5%9D%80"><span class="toc-number">2.2.2.</span> <span class="toc-text">常用的三种类别的 IP 地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IP-%E5%9C%B0%E5%9D%80%E7%9A%84%E4%B8%80%E4%BA%9B%E9%87%8D%E8%A6%81%E7%89%B9%E7%82%B9"><span class="toc-number">2.2.3.</span> <span class="toc-text">IP 地址的一些重要特点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IP-%E5%9C%B0%E5%9D%80%E4%B8%8E%E7%A1%AC%E4%BB%B6%E5%9C%B0%E5%9D%80"><span class="toc-number">2.3.</span> <span class="toc-text">IP 地址与硬件地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E8%A7%A3%E6%9E%90%E5%8D%8F%E8%AE%AE-ARP"><span class="toc-number">2.4.</span> <span class="toc-text">地址解析协议 ARP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">2.4.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">2.4.2.</span> <span class="toc-text">工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARP-%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98"><span class="toc-number">2.4.3.</span> <span class="toc-text">ARP 高速缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%90%8C%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.4.4.</span> <span class="toc-text">不同应用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%E7%A1%AC%E4%BB%B6%E5%9C%B0%E5%9D%80%EF%BC%9F"><span class="toc-number">2.4.5.</span> <span class="toc-text">为什么不直接使用硬件地址？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IP-%E6%95%B0%E6%8D%AE%E6%8A%A5%E7%9A%84%E6%A0%BC%E5%BC%8F"><span class="toc-number">2.5.</span> <span class="toc-text">IP 数据报的格式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IP-%E6%95%B0%E6%8D%AE%E6%8A%A5%E9%A6%96%E9%83%A8%E7%9A%84%E5%9B%BA%E5%AE%9A%E9%83%A8%E5%88%86%E4%B8%AD%E7%9A%84%E5%90%84%E5%AD%97%E6%AE%B5"><span class="toc-number">2.5.1.</span> <span class="toc-text">IP 数据报首部的固定部分中的各字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IP-%E6%95%B0%E6%8D%AE%E6%8A%A5%E9%A6%96%E9%83%A8%E7%9A%84%E5%8F%AF%E5%8F%98%E9%83%A8%E5%88%86"><span class="toc-number">2.5.2.</span> <span class="toc-text">IP 数据报首部的可变部分</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IP-%E5%B1%82%E8%BD%AC%E5%8F%91%E5%88%86%E7%BB%84%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">2.6.</span> <span class="toc-text">IP 层转发分组的流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E8%B7%AF%E7%94%B1%E8%A1%A8"><span class="toc-number">2.6.1.</span> <span class="toc-text">查找路由表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E5%AE%9A%E4%B8%BB%E6%9C%BA%E8%B7%AF%E7%94%B1"><span class="toc-number">2.6.2.</span> <span class="toc-text">特定主机路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E8%B7%AF%E7%94%B1-default-route"><span class="toc-number">2.6.3.</span> <span class="toc-text">默认路由 (default route)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%99%A8%E5%88%86%E7%BB%84%E8%BD%AC%E5%8F%91%E7%AE%97%E6%B3%95"><span class="toc-number">2.6.4.</span> <span class="toc-text">路由器分组转发算法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%92%E5%88%86%E5%AD%90%E7%BD%91%E5%92%8C%E6%9E%84%E9%80%A0%E8%B6%85%E7%BD%91"><span class="toc-number">3.</span> <span class="toc-text">划分子网和构造超网</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%92%E5%88%86%E5%AD%90%E7%BD%91"><span class="toc-number">3.1.</span> <span class="toc-text">划分子网</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81"><span class="toc-number">3.1.1.</span> <span class="toc-text">子网掩码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%90%E7%BD%91%E5%88%92%E5%88%86%E6%96%B9%E6%B3%95"><span class="toc-number">3.1.2.</span> <span class="toc-text">子网划分方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%AD%90%E7%BD%91%E6%97%B6%E5%88%86%E7%BB%84%E7%9A%84%E8%BD%AC%E5%8F%91"><span class="toc-number">3.2.</span> <span class="toc-text">使用子网时分组的转发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E5%88%86%E7%B1%BB%E7%BC%96%E5%9D%80-CIDR%EF%BC%88%E6%9E%84%E9%80%A0%E8%B6%85%E7%BD%91%EF%BC%89"><span class="toc-number">3.3.</span> <span class="toc-text">无分类编址 CIDR（构造超网）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E7%82%B9"><span class="toc-number">3.3.1.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CIDR-%E5%9C%B0%E5%9D%80%E5%9D%97"><span class="toc-number">3.3.2.</span> <span class="toc-text">CIDR 地址块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%BD%A2%E5%BC%8F%E7%9A%84%E8%AE%B0%E6%B3%95"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">其他形式的记法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E8%81%9A%E5%90%88-route-aggregation"><span class="toc-number">3.3.3.</span> <span class="toc-text">路由聚合 (route aggregation)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E9%95%BF%E5%89%8D%E7%BC%80%E5%8C%B9%E9%85%8D"><span class="toc-number">3.3.4.</span> <span class="toc-text">最长前缀匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E4%BA%8C%E5%8F%89%E7%BA%BF%E7%B4%A2%E6%9F%A5%E6%89%BE%E8%B7%AF%E7%94%B1%E8%A1%A8"><span class="toc-number">3.3.5.</span> <span class="toc-text">使用二叉线索查找路由表</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E9%99%85%E6%8E%A7%E5%88%B6%E6%8A%A5%E6%96%87%E5%8D%8F%E8%AE%AE-ICMP"><span class="toc-number">4.</span> <span class="toc-text">网际控制报文协议 ICMP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ICMP-%E6%8A%A5%E6%96%87%E7%9A%84%E7%A7%8D%E7%B1%BB"><span class="toc-number">4.1.</span> <span class="toc-text">ICMP 报文的种类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP-%E5%B7%AE%E9%94%99%E6%8A%A5%E5%91%8A%E6%8A%A5%E6%96%87"><span class="toc-number">4.1.1.</span> <span class="toc-text">ICMP 差错报告报文</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP-%E8%AF%A2%E9%97%AE%E6%8A%A5%E6%96%87"><span class="toc-number">4.1.2.</span> <span class="toc-text">ICMP 询问报文</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ICMP-%E7%9A%84%E5%BA%94%E7%94%A8%E4%B8%BE%E4%BE%8B"><span class="toc-number">4.2.</span> <span class="toc-text">ICMP 的应用举例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PING-Packet-InterNet-Groper"><span class="toc-number">4.2.1.</span> <span class="toc-text">PING (Packet InterNet Groper)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Traceroute"><span class="toc-number">4.2.2.</span> <span class="toc-text">Traceroute</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%92%E8%81%94%E7%BD%91%E7%9A%84%E8%B7%AF%E7%94%B1%E9%80%89%E6%8B%A9%E5%8D%8F%E8%AE%AE"><span class="toc-number">5.</span> <span class="toc-text">互联网的路由选择协议</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E5%85%B3%E8%B7%AF%E7%94%B1%E9%80%89%E6%8B%A9%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%87%A0%E4%B8%AA%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">5.1.</span> <span class="toc-text">有关路由选择协议的几个基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%90%86%E6%83%B3%E7%9A%84%E8%B7%AF%E7%94%B1%E7%AE%97%E6%B3%95"><span class="toc-number">5.1.1.</span> <span class="toc-text">理想的路由算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B1%82%E6%AC%A1%E7%9A%84%E8%B7%AF%E7%94%B1%E9%80%89%E6%8B%A9%E5%8D%8F%E8%AE%AE"><span class="toc-number">5.1.2.</span> <span class="toc-text">分层次的路由选择协议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E6%B2%BB%E7%B3%BB%E7%BB%9F-AS"><span class="toc-number">5.1.2.1.</span> <span class="toc-text">自治系统 AS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E7%BD%91%E5%85%B3%E5%8D%8F%E8%AE%AE-IGP-Interior-Gateway-Protocol"><span class="toc-number">5.1.2.2.</span> <span class="toc-text">内部网关协议 IGP (Interior Gateway Protocol)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E7%BD%91%E5%85%B3%E5%8D%8F%E8%AE%AE-EGP-External-Gateway-Protocol"><span class="toc-number">5.1.2.3.</span> <span class="toc-text">外部网关协议 EGP (External Gateway Protocol)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E7%BD%91%E5%85%B3%E5%8D%8F%E8%AE%AE-RIP"><span class="toc-number">5.2.</span> <span class="toc-text">内部网关协议 RIP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">5.2.1.</span> <span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E7%82%B9-1"><span class="toc-number">5.2.2.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B%EF%BC%88%E8%B7%AF%E7%94%B1%E8%A1%A8%E7%9A%84%E5%BB%BA%E7%AB%8B%EF%BC%89"><span class="toc-number">5.2.3.</span> <span class="toc-text">工作过程（路由表的建立）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%9D%E7%A6%BB%E9%87%8F%E7%AE%97%E6%B3%95"><span class="toc-number">5.2.4.</span> <span class="toc-text">距离量算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RIP2-%E5%8D%8F%E8%AE%AE%E7%9A%84%E6%8A%A5%E6%96%87%E6%A0%BC%E5%BC%8F"><span class="toc-number">5.2.5.</span> <span class="toc-text">RIP2 协议的报文格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RIP-%E5%8D%8F%E8%AE%AE%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">5.2.6.</span> <span class="toc-text">RIP 协议的优缺点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E7%BD%91%E5%85%B3%E5%8D%8F%E8%AE%AE-OSPF"><span class="toc-number">5.3.</span> <span class="toc-text">内部网关协议 OSPF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E7%82%B9-2"><span class="toc-number">5.3.1.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F"><span class="toc-number">5.3.2.</span> <span class="toc-text">工作方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OSPF-%E7%9B%B4%E6%8E%A5%E7%94%A8-IP-%E6%95%B0%E6%8D%AE%E6%8A%A5%E4%BC%A0%E9%80%81"><span class="toc-number">5.3.3.</span> <span class="toc-text">OSPF 直接用 IP 数据报传送</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%B9%B3%E8%A1%A1"><span class="toc-number">5.3.4.</span> <span class="toc-text">负载平衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OSPF-%E5%88%86%E7%BB%84"><span class="toc-number">5.3.5.</span> <span class="toc-text">OSPF 分组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E7%9A%84%E8%B7%AF%E7%94%B1%E5%99%A8"><span class="toc-number">5.3.6.</span> <span class="toc-text">指定的路由器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E7%BD%91%E5%85%B3%E5%8D%8F%E8%AE%AE-BGP"><span class="toc-number">5.4.</span> <span class="toc-text">外部网关协议 BGP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BGP-%E5%8F%91%E8%A8%80%E4%BA%BA"><span class="toc-number">5.4.1.</span> <span class="toc-text">BGP 发言人</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BGP-%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F%EF%BC%88%E4%BA%A4%E6%8D%A2%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF%EF%BC%89"><span class="toc-number">5.4.2.</span> <span class="toc-text">BGP 工作方式（交换路由信息）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E7%82%B9-3"><span class="toc-number">5.4.3.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BGP-4%E6%8A%A5%E6%96%87"><span class="toc-number">5.4.4.</span> <span class="toc-text">BGP-4报文</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%99%A8%E7%9A%84%E6%9E%84%E6%88%90"><span class="toc-number">6.</span> <span class="toc-text">路由器的构成</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%99%A8%E7%9A%84%E7%BB%93%E6%9E%84%E4%BB%A5%E5%8F%8A%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F"><span class="toc-number">6.1.</span> <span class="toc-text">路由器的结构以及工作方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E7%BB%84%E4%B8%A2%E5%BC%83"><span class="toc-number">6.2.</span> <span class="toc-text">分组丢弃</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%A4%E6%8D%A2%E7%BB%93%E6%9E%84"><span class="toc-number">6.3.</span> <span class="toc-text">交换结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%AD%98%E5%82%A8%E5%99%A8"><span class="toc-number">6.3.1.</span> <span class="toc-text">通过存储器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%80%BB%E7%BA%BF"><span class="toc-number">6.3.2.</span> <span class="toc-text">通过总线</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E7%BA%B5%E6%A8%AA%E4%BA%A4%E6%8D%A2%E7%BB%93%E6%9E%84-crossbar-switch-fabric"><span class="toc-number">6.3.3.</span> <span class="toc-text">通过纵横交换结构 (crossbar switch fabric)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IPv6"><span class="toc-number">7.</span> <span class="toc-text">IPv6</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IPv6-%E7%9A%84%E5%9F%BA%E6%9C%AC%E9%A6%96%E9%83%A8"><span class="toc-number">7.1.</span> <span class="toc-text">IPv6 的基本首部</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IPv6-%E7%9A%84%E5%9C%B0%E5%9D%80"><span class="toc-number">7.2.</span> <span class="toc-text">IPv6 的地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E-IPv4-%E5%90%91-IPv6-%E8%BF%87%E6%B8%A1"><span class="toc-number">7.3.</span> <span class="toc-text">从 IPv4 向 IPv6 过渡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8C%E5%8D%8F%E8%AE%AE%E6%A0%88"><span class="toc-number">7.3.1.</span> <span class="toc-text">双协议栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF"><span class="toc-number">7.3.2.</span> <span class="toc-text">隧道技术</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ICMPv6"><span class="toc-number">7.4.</span> <span class="toc-text">ICMPv6</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IP-%E5%A4%9A%E6%92%AD"><span class="toc-number">8.</span> <span class="toc-text">IP 多播</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IP-%E5%A4%9A%E6%92%AD%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">8.1.</span> <span class="toc-text">IP 多播的基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%92%AD-IP-%E5%9C%B0%E5%9D%80"><span class="toc-number">8.1.1.</span> <span class="toc-text">多播 IP 地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%92%AD%E6%95%B0%E6%8D%AE%E6%8A%A5"><span class="toc-number">8.1.2.</span> <span class="toc-text">多播数据报</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E5%B1%80%E5%9F%9F%E7%BD%91%E4%B8%8A%E8%BF%9B%E8%A1%8C%E7%A1%AC%E4%BB%B6%E5%A4%9A%E6%92%AD"><span class="toc-number">8.2.</span> <span class="toc-text">在局域网上进行硬件多播</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E9%99%85%E7%BB%84%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE-IGMP-%E5%92%8C%E5%A4%9A%E6%92%AD%E8%B7%AF%E7%94%B1%E9%80%89%E6%8B%A9%E5%8D%8F%E8%AE%AE"><span class="toc-number">8.3.</span> <span class="toc-text">网际组管理协议 IGMP 和多播路由选择协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">8.3.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E9%99%85%E7%BB%84%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE-IGMP"><span class="toc-number">8.3.2.</span> <span class="toc-text">网际组管理协议 IGMP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5%EF%BC%9A%E5%8A%A0%E5%85%A5%E5%A4%9A%E6%92%AD%E7%BB%84"><span class="toc-number">8.3.2.1.</span> <span class="toc-text">第一阶段：加入多播组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%8E%A2%E8%AF%A2%E7%BB%84%E6%88%90%E5%91%98%E5%8F%98%E5%8C%96%E6%83%85%E5%86%B5"><span class="toc-number">8.3.2.2.</span> <span class="toc-text">第二阶段：探询组成员变化情况</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%92%AD%E8%B7%AF%E7%94%B1%E9%80%89%E6%8B%A9"><span class="toc-number">8.3.3.</span> <span class="toc-text">多播路由选择</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B4%AA%E6%B3%9B%E4%B8%8E%E5%89%AA%E9%99%A4"><span class="toc-number">8.3.3.1.</span> <span class="toc-text">洪泛与剪除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF-tunneling"><span class="toc-number">8.3.3.2.</span> <span class="toc-text">隧道技术 (tunneling)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%A0%B8%E5%BF%83%E7%9A%84%E5%8F%91%E7%8E%B0%E6%8A%80%E6%9C%AF"><span class="toc-number">8.3.3.3.</span> <span class="toc-text">基于核心的发现技术</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E4%B8%93%E7%94%A8%E7%BD%91-VPN-%E5%92%8C%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2-NAT"><span class="toc-number">9.</span> <span class="toc-text">虚拟专用网 VPN 和网络地址转换 NAT</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E4%B8%93%E7%94%A8%E7%BD%91-VPN"><span class="toc-number">9.1.</span> <span class="toc-text">虚拟专用网 VPN</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%8E%A5%E5%85%A5-VPN"><span class="toc-number">9.1.1.</span> <span class="toc-text">远程接入 VPN</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2-NAT"><span class="toc-number">9.2.</span> <span class="toc-text">网络地址转换 NAT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NAT%E4%BD%BF%E7%94%A8%E5%89%8D%E6%8F%90"><span class="toc-number">9.2.1.</span> <span class="toc-text">NAT使用前提</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E4%B8%8E%E7%AB%AF%E5%8F%A3%E5%8F%B7%E8%BD%AC%E6%8D%A2-NAPT"><span class="toc-number">9.2.2.</span> <span class="toc-text">网络地址与端口号转换 NAPT</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%9A%E5%8D%8F%E8%AE%AE%E6%A0%87%E8%AE%B0%E4%BA%A4%E6%8D%A2-MPLS"><span class="toc-number">10.</span> <span class="toc-text">多协议标记交换 MPLS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MPLS-%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">10.1.</span> <span class="toc-text">MPLS 的工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B"><span class="toc-number">10.1.1.</span> <span class="toc-text">基本工作过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MPLS-%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B"><span class="toc-number">10.2.</span> <span class="toc-text">MPLS 的基本工作过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AC%E5%8F%91%E7%AD%89%E4%BB%B7%E7%B1%BB-FEC"><span class="toc-number">10.3.</span> <span class="toc-text">转发等价类 FEC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E9%87%8F%E5%B7%A5%E7%A8%8B"><span class="toc-number">10.3.1.</span> <span class="toc-text">流量工程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MPLS-%E9%A6%96%E9%83%A8%E7%9A%84%E4%BD%8D%E7%BD%AE%E4%B8%8E%E6%A0%BC%E5%BC%8F"><span class="toc-number">10.4.</span> <span class="toc-text">MPLS 首部的位置与格式</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/09/10/XSS/" title="Web安全-XSS"><img src="/img/code.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Web安全-XSS"/></a><div class="content"><a class="title" href="/2022/09/10/XSS/" title="Web安全-XSS">Web安全-XSS</a><time datetime="2022-09-10T07:28:20.000Z" title="发表于 2022-09-10 15:28:20">2022-09-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/15/%E9%87%8D%E5%9B%9E%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%92%8C%E9%97%AD%E5%8C%85/" title="重回作用域和闭包"><img src="/img/code.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="重回作用域和闭包"/></a><div class="content"><a class="title" href="/2022/05/15/%E9%87%8D%E5%9B%9E%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%92%8C%E9%97%AD%E5%8C%85/" title="重回作用域和闭包">重回作用域和闭包</a><time datetime="2022-05-14T16:00:00.000Z" title="发表于 2022-05-15 00:00:00">2022-05-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/22/CSRF/" title="Web安全-CSRF"><img src="/img/code.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Web安全-CSRF"/></a><div class="content"><a class="title" href="/2022/04/22/CSRF/" title="Web安全-CSRF">Web安全-CSRF</a><time datetime="2022-04-22T07:28:20.000Z" title="发表于 2022-04-22 15:28:20">2022-04-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/18/NPM%20%E6%93%8D%E4%BD%9C/" title="npm操作"><img src="/img/code.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="npm操作"/></a><div class="content"><a class="title" href="/2022/04/18/NPM%20%E6%93%8D%E4%BD%9C/" title="npm操作">npm操作</a><time datetime="2022-04-18T07:00:00.000Z" title="发表于 2022-04-18 15:00:00">2022-04-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/15/node-token%E7%99%BB%E9%99%86%E6%B3%A8%E5%86%8C%E9%AA%8C%E8%AF%81/" title="node登陆验证之jsonwebtoken"><img src="/img/code.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="node登陆验证之jsonwebtoken"/></a><div class="content"><a class="title" href="/2022/04/15/node-token%E7%99%BB%E9%99%86%E6%B3%A8%E5%86%8C%E9%AA%8C%E8%AF%81/" title="node登陆验证之jsonwebtoken">node登陆验证之jsonwebtoken</a><time datetime="2022-04-15T13:40:39.000Z" title="发表于 2022-04-15 21:40:39">2022-04-15</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/code.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 天际线上的猪</div><div class="footer_custom_text">Hi, Welcome to my blog</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'K4oel47dX9gLB9DECHDKW5HF-gzGzoHsz',
      appKey: 'FI26zV0So19K2wVMY6Ds4nAA',
      avatar: 'hide',
      serverURLs: '',
      emojiMaps: {"tv_doge":"6ea59c827c414b4a2955fe79e0f6fd3dcd515e24.png","tv_亲亲":"a8111ad55953ef5e3be3327ef94eb4a39d535d06.png","tv_偷笑":"bb690d4107620f1c15cff29509db529a73aee261.png","tv_再见":"180129b8ea851044ce71caf55cc8ce44bd4a4fc8.png","tv_冷漠":"b9cbc755c2b3ee43be07ca13de84e5b699a3f101.png","tv_发怒":"34ba3cd204d5b05fec70ce08fa9fa0dd612409ff.png","tv_发财":"34db290afd2963723c6eb3c4560667db7253a21a.png","tv_可爱":"9e55fd9b500ac4b96613539f1ce2f9499e314ed9.png","tv_吐血":"09dd16a7aa59b77baa1155d47484409624470c77.png","tv_呆":"fe1179ebaa191569b0d31cecafe7a2cd1c951c9d.png","tv_呕吐":"9f996894a39e282ccf5e66856af49483f81870f3.png","tv_困":"241ee304e44c0af029adceb294399391e4737ef2.png","tv_坏笑":"1f0b87f731a671079842116e0991c91c2c88645a.png","tv_大佬":"093c1e2c490161aca397afc45573c877cdead616.png","tv_大哭":"23269aeb35f99daee28dda129676f6e9ea87934f.png","tv_委屈":"d04dba7b5465779e9755d2ab6f0a897b9b33bb77.png","tv_害羞":"a37683fb5642fa3ddfc7f4e5525fd13e42a2bdb1.png","tv_尴尬":"7cfa62dafc59798a3d3fb262d421eeeff166cfa4.png","tv_微笑":"70dc5c7b56f93eb61bddba11e28fb1d18fddcd4c.png","tv_思考":"90cf159733e558137ed20aa04d09964436f618a1.png","tv_惊吓":"0d15c7e2ee58e935adc6a7193ee042388adc22af.png"},
      path: window.location.pathname,
      visitor: false
    }, {"requiredFields":"nick,mail"}))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>